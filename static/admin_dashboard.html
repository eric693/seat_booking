<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†å¾Œå° â€” æœƒè­°å®¤é ç´„ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0F0F0F;
  --ink-60: rgba(15,15,15,0.6);
  --ink-20: rgba(15,15,15,0.1);
  --paper: #F5F2ED;
  --white: #FFFFFF;
  --gold: #B8965A;
  --gold-light: #F2E8D5;
  --teal: #2A6B6B;
  --teal-light: #E8F2F2;
  --red: #C44B3A;
  --red-light: #FFF0EE;
  --green: #3A7C55;
  --green-light: #EEF7F2;
  --border: rgba(15,15,15,0.1);
  --sidebar: 240px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}

body { font-family:'DM Sans',sans-serif; background:var(--paper); color:var(--ink); display:flex; min-height:100vh; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: var(--sidebar);
  background: var(--ink);
  color: white;
  position: fixed;
  top:0; left:0; bottom:0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.sidebar-logo {
  padding: 20px 20px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-logo-icon {
  width: 32px; height: 32px;
  background: var(--gold);
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.sidebar-logo-text {
  font-family: 'DM Serif Display', serif;
  font-size: 15px;
  line-height: 1.2;
}

.sidebar-logo-text small {
  display: block;
  font-family: 'DM Sans', sans-serif;
  font-size: 10px;
  color: rgba(255,255,255,0.4);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

nav { padding: 12px 0; flex: 1; }

.nav-section {
  padding: 8px 16px 4px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(255,255,255,0.3);
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 14px;
  color: rgba(255,255,255,0.6);
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
.nav-item.active { color: white; background: rgba(184,150,90,0.15); border-left-color: var(--gold); }
.nav-icon { width: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0.75; }
.nav-item:hover .nav-icon, .nav-item.active .nav-icon { opacity: 1; }

.sidebar-bottom {
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.08);
}

.logout-btn {
  width: 100%;
  padding: 9px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.6);
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-family: inherit;
  transition: all 0.2s;
}
.logout-btn:hover { background: rgba(196,75,58,0.2); color: #ff8a80; border-color: rgba(196,75,58,0.3); }

/* â”€â”€ MAIN â”€â”€ */
.main {
  margin-left: var(--sidebar);
  flex: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.topbar {
  background: white;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 50;
}

.topbar-title {
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.preview-btn {
  padding: 8px 16px;
  background: var(--teal);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  transition: all 0.2s;
}
.preview-btn:hover { background: #1e5050; }

.content { padding: 32px; flex: 1; }

.page { display: none; }
.page.active { display: block; }

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.stat-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 22px 24px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--gold);
}

.stat-lbl {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-60);
  font-weight: 600;
  margin-bottom: 8px;
}

.stat-val {
  font-family: 'DM Serif Display', serif;
  font-size: 36px;
  color: var(--ink);
  line-height: 1;
  margin-bottom: 4px;
}

.stat-sub { font-size: 12px; color: var(--ink-60); }

/* â”€â”€ CARD â”€â”€ */
.card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 24px;
}

.card-head {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
}

.card-body { padding: 24px; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  padding: 9px 18px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  font-family: inherit;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary { background: var(--teal); color: white; }
.btn-primary:hover { background: #1e5050; }
.btn-gold { background: var(--gold); color: white; }
.btn-gold:hover { background: #9a7a48; }
.btn-danger { background: var(--red); color: white; }
.btn-danger:hover { background: #a33d2e; }
.btn-outline { background: none; border: 1.5px solid var(--border); color: var(--ink); }
.btn-outline:hover { border-color: var(--ink); }
.btn-sm { padding: 6px 12px; font-size: 12px; }

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; }
th {
  background: var(--paper);
  padding: 10px 14px;
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  color: var(--ink-60);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  border-bottom: 1px solid var(--border);
}
td { padding: 13px 14px; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
tr:hover td { background: #fafafa; }

/* â”€â”€ BADGE â”€â”€ */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 12px;
  font-weight: 500;
}
.badge-green { background: var(--green-light); color: var(--green); }
.badge-red { background: var(--red-light); color: var(--red); }
.badge-gold { background: var(--gold-light); color: #8a6e3e; }
.badge-gray { background: #f0f0f0; color: #666; }
.badge-superadmin { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
.badge-admin { background: var(--teal-light); color: var(--teal); }
.badge-manager { background: #f0f0f0; color: #555; }
.badge-staff { background: #f8f9fa; color: #888; }

/* â”€â”€ FILTERS â”€â”€ */
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.filter-lbl { font-size: 13px; color: var(--ink-60); }

.filter-input, .filter-select {
  padding: 7px 12px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  font-family: inherit;
  color: var(--ink);
  background: white;
}
.filter-input:focus, .filter-select:focus { outline: none; border-color: var(--teal); }

/* â”€â”€ MODAL â”€â”€ */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.modal.show { display: flex; }

.modal-box {
  background: white;
  border-radius: 10px;
  padding: 32px;
  max-width: 600px;
  width: 92%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  margin-bottom: 24px;
}

.modal-footer {
  margin-top: 24px;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* â”€â”€ FORM â”€â”€ */
.fg { margin-bottom: 18px; }
.fg label {
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
}
.fg label span { font-weight: 400; color: var(--ink-60); font-size: 12px; }
.finput, .fselect, .ftarea {
  width: 100%;
  padding: 10px 13px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  font-size: 14px;
  font-family: inherit;
  color: var(--ink);
  background: white;
  transition: border-color 0.2s;
}
.finput:focus, .fselect:focus, .ftarea:focus { outline: none; border-color: var(--teal); }
.ftarea { resize: vertical; min-height: 90px; }
.fselect { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }
.fgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* â”€â”€ PHOTO UPLOAD â”€â”€ */
.photo-upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 28px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--paper);
  position: relative;
}
.photo-upload-area:hover { border-color: var(--teal); background: var(--teal-light); }
.photo-upload-area.dragover { border-color: var(--gold); background: var(--gold-light); }
.photo-upload-icon { font-size: 32px; margin-bottom: 10px; }
.photo-upload-text { font-size: 14px; color: var(--ink-60); }
.photo-upload-text strong { color: var(--teal); }
#photoFileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

.photo-preview {
  position: relative;
  display: inline-block;
  margin-top: 12px;
}
.photo-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 6px;
  object-fit: cover;
  border: 2px solid var(--border);
}
.photo-preview-remove {
  position: absolute;
  top: -8px; right: -8px;
  width: 24px; height: 24px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
}

.current-photo-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 12px;
}
.current-photo-row img {
  width: 60px; height: 45px;
  object-fit: cover;
  border-radius: 4px;
}
.current-photo-row span { font-size: 13px; color: var(--ink-60); }

/* â”€â”€ AMENITIES â”€â”€ */
.amenity-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}
.amenity-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.amenity-tag {
  background: var(--gold-light);
  color: #8a6e3e;
  border: 1px solid rgba(184,150,90,0.3);
  padding: 4px 10px;
  border-radius: 100px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.amenity-remove { cursor: pointer; color: var(--gold); font-weight: bold; font-size: 14px; line-height: 1; }
.amenity-remove:hover { color: var(--red); }

/* â”€â”€ SITE CONTENT PAGE â”€â”€ */
.content-sections {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.content-section {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

.cs-head {
  background: var(--paper);
  padding: 14px 18px;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--ink-60);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}

.cs-body { padding: 16px; }

.cs-field { margin-bottom: 14px; }
.cs-field:last-child { margin-bottom: 0; }
.cs-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--ink-60);
  margin-bottom: 5px;
  display: block;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* â”€â”€ ROOM CARDS ADMIN â”€â”€ */
.floor-section{margin-bottom:22px;}
.floor-label{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-60);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.room-row{display:grid;grid-template-columns:150px 1fr;align-items:center;gap:10px;margin-bottom:7px;min-width:640px;}
.room-row-name{font-size:13px;font-weight:600;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.room-row-cap{font-size:11px;color:var(--ink-60);}
.slots-wrap{display:flex;gap:2px;}
.slot-cell{flex:1;height:30px;border-radius:3px;position:relative;cursor:default;min-width:16px;transition:transform .1s;}
.slot-cell:hover{transform:scaleY(1.2);z-index:2;}
.slot-cell.free{background:#3A7C55;}
.slot-cell.booked{background:#C44B3A;}
.slot-cell.now-free{background:#B8965A;}
.slot-cell.now-booked{background:#8B3022;}
.slot-cell.past{background:var(--ink-20);}
.slot-cell .stip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--ink);color:#fff;font-size:11px;padding:4px 8px;border-radius:4px;white-space:nowrap;z-index:100;pointer-events:none;}
.slot-cell:hover .stip{display:block;}
.time-axis{display:flex;gap:2px;padding-left:160px;margin-bottom:4px;min-width:640px;}
.time-tick{flex:1;font-size:10px;color:var(--ink-60);min-width:16px;}
.room-admin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.room-admin-card {
  background: white;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  transition: box-shadow 0.2s;
}
.room-admin-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.room-admin-card.inactive { opacity: 0.5; }

.rac-photo {
  width: 100%; height: 140px;
  object-fit: cover;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  color: rgba(255,255,255,0.2);
  position: relative;
}

.rac-photo img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.rac-photo-placeholder {
  width: 100%; height: 140px;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  color: rgba(255,255,255,0.2);
}

.rac-status {
  position: absolute;
  top: 8px; right: 8px;
  padding: 3px 8px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
}

.rac-body { padding: 16px; }
.rac-type { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin-bottom: 4px; }
.rac-name { font-family: 'DM Serif Display', serif; font-size: 18px; margin-bottom: 6px; }
.rac-desc {
  font-size: 12px;
  color: var(--ink-60);
  line-height: 1.5;
  margin-top: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.rac-meta { font-size: 13px; color: var(--ink-60); margin-bottom: 12px; }
.rac-actions { display: flex; gap: 8px; border-top: 1px solid var(--border); padding-top: 14px; }

/* upload progress */
.upload-progress {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
  display: none;
}
.upload-progress-bar {
  height: 100%;
  background: var(--teal);
  border-radius: 2px;
  transition: width 0.3s;
}

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--ink);
  color: white;
  padding: 14px 20px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 9999;
  transform: translateY(80px);
  opacity: 0;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 360px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--teal); }
.toast.error { background: var(--red); }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon" id="sidebarLogoIcon">MR</div>
    <div class="sidebar-logo-text">
      æœƒè­°å®¤ç³»çµ±
      <small>Admin Panel</small>
    </div>
  </div>
  <nav>
    <div class="nav-section">ç¸½è¦½</div>
    <div class="nav-item active" onclick="showPage('dashboard',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg></span> å„€è¡¨æ¿
    </div>
    <div class="nav-section">ç®¡ç†</div>
    <div class="nav-item" onclick="showPage('bookings',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="12" height="13" rx="1.5"/><path d="M5 1v2M11 1v2"/><path d="M2 6h12"/><path d="M5 9.5h1.5M9 9.5h2M5 12h1.5M9 12h2"/></svg></span> é ç´„ç®¡ç†
    </div>
    <div class="nav-item" onclick="showPage('rooms',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 14V5l7-4 7 4v9"/><path d="M6 14v-4h4v4"/><path d="M1 14h14"/></svg></span> æœƒè­°å®¤ç®¡ç†
    </div>
    <div class="nav-section">å‰å°è¨­å®š</div>
    <div class="nav-item" onclick="showPage('content',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4h12M2 8h8M2 12h6"/><path d="M11 10l3.5-3.5a1.2 1.2 0 0 1 1.7 1.7L12.7 12l-2 .5.5-2z"/></svg></span> æ–‡å­—å…§å®¹ç·¨è¼¯
    </div>
    <div class="nav-item" onclick="showPage('photos',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="14" height="10" rx="1.5"/><circle cx="6" cy="8" r="2"/><path d="M10 6l4 4"/></svg></span> ç…§ç‰‡ç®¡ç†
    </div>
    <div class="nav-item" onclick="showPage('formfields',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="14" height="3" rx="1"/><rect x="1" y="9" width="14" height="3" rx="1"/><path d="M4 2v2M4 13v1"/></svg></span> è¡¨å–®æ¬„ä½
    </div>
    <div class="nav-item" onclick="showPage('blocked',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="6.5"/><path d="M3.4 3.4l9.2 9.2"/></svg></span> å°é–æ™‚æ®µ
    </div>
    <div class="nav-section">ç³»çµ±</div>
    <div class="nav-item" onclick="showPage('accounts',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="5" r="2.5"/><path d="M1 14c0-2.8 2.2-5 5-5s5 2.2 5 5"/><path d="M11 7.5l1.5 1.5L15 6.5"/></svg></span> å¸³è™Ÿç®¡ç†
    </div>
    <div class="nav-item" onclick="showPage('logs',this)">
      <span class="nav-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="1" width="12" height="14" rx="1.5"/><path d="M5 5h6M5 8h6M5 11h3"/><circle cx="12.5" cy="12.5" r="2.5" fill="currentColor" stroke="none" opacity=".3"/><path d="M11.5 12.5h2M12.5 11.5v2" stroke="currentColor" stroke-width="1.2"/></svg></span> ç™»å…¥ç´€éŒ„
    </div>
  </nav>
  <div class="sidebar-bottom">
    <div id="currentUserInfo" style="margin-bottom:10px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6;"></div>
    <button class="logout-btn" onclick="logout()">ç™»å‡ºå¾Œå°</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">å„€è¡¨æ¿</div>
    <div class="topbar-right">
      <button class="preview-btn" onclick="window.open('/', '_blank')">æŸ¥çœ‹å‰å°</button>
    </div>
  </div>

  <div class="content">

    <!-- â”€â”€ DASHBOARD â”€â”€ -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-lbl">æœ‰æ•ˆé ç´„</div>
          <div class="stat-val" id="st-total">â€”</div>
          <div class="stat-sub">ç´¯è¨ˆç¢ºèª</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">ä»Šæ—¥é ç´„</div>
          <div class="stat-val" id="st-today">â€”</div>
          <div class="stat-sub">ä»Šå¤©</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">å¯ç”¨æœƒè­°å®¤</div>
          <div class="stat-val" id="st-rooms">â€”</div>
          <div class="stat-sub">å·²å•Ÿç”¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">ç´¯è¨ˆç‡Ÿæ”¶</div>
          <div class="stat-val" id="st-revenue">â€”</div>
          <div class="stat-sub">NT$</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">å·²å–æ¶ˆ</div>
          <div class="stat-val" id="st-cancelled">â€”</div>
          <div class="stat-sub">å–æ¶ˆæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">å·²å®Œæˆ</div>
          <div class="stat-val" id="st-completed">â€”</div>
          <div class="stat-sub">å®Œæˆæ•¸</div>
        </div>
      </div>

      <!-- â”€â”€ æ¨“å±¤æ™‚æ®µçœ‹æ¿ â”€â”€ -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div class="card-title">æ¨“å±¤æ™‚æ®µçœ‹æ¿</div>
          <div style="display:flex;align-items:center;gap:12px;">
            <input type="date" id="floor-date" class="filter-input"
              style="font-size:13px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--white);"
              onchange="loadFloorStatus()">
            <button class="btn btn-outline btn-sm" onclick="loadFloorStatus()">é‡æ–°æ•´ç†</button>
          </div>
        </div>
        <div class="card-body" style="padding:16px 20px;">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#3A7C55;"></div> ç©ºé–’
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#C44B3A;"></div> å·²é ç´„
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#B8965A;"></div> é€²è¡Œä¸­
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:var(--ink-20);"></div> éæœå‹™æ™‚æ®µ
            </div>
          </div>
          <div id="floor-board" style="overflow-x:auto;">
            <div style="text-align:center;padding:30px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">æœ€æ–°é ç´„</div>
          <button class="btn btn-outline btn-sm" onclick="showPage('bookings', document.querySelector('[onclick*=bookings]'))">æŸ¥çœ‹å…¨éƒ¨</button>
        </div>
        <div class="card-body">
          <div class="filters" style="margin-bottom:16px;">
            <div class="filter-group">
              <span class="filter-lbl">æ—¥æœŸ</span>
              <input type="date" class="filter-input" id="dash-fil-date" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
            </div>
            <div class="filter-group">
              <span class="filter-lbl">ç‹€æ…‹</span>
              <select class="filter-select" id="dash-fil-status" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
                <option value="">å…¨éƒ¨</option>
                <option value="confirmed">å·²ç¢ºèª</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
                <option value="completed">å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="filter-lbl">æœƒè­°å®¤</span>
              <select class="filter-select" id="dash-fil-room" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>
            <button class="btn btn-outline btn-sm" onclick="clearDashFilters()">æ¸…é™¤ç¯©é¸</button>
          </div>
          <div class="tbl-wrap">
            <table>
              <thead><tr>
                <th>é ç´„ç·¨è™Ÿ</th><th>è¯çµ¡äºº</th><th>æœƒè­°å®¤</th><th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th>
              </tr></thead>
              <tbody id="dash-bookings"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ BOOKINGS â”€â”€ -->
    <div class="page" id="page-bookings">
      <div class="card">
        <div class="card-head">
          <div class="card-title">é ç´„ç®¡ç†</div>
        </div>
        <div class="card-body">
          <div class="filters">
            <div class="filter-group">
              <span class="filter-lbl">æ—¥æœŸ</span>
              <input type="date" class="filter-input" id="fil-date" onchange="loadBookings()">
            </div>
            <div class="filter-group">
              <span class="filter-lbl">ç‹€æ…‹</span>
              <select class="filter-select" id="fil-status" onchange="loadBookings()">
                <option value="">å…¨éƒ¨</option>
                <option value="confirmed">å·²ç¢ºèª</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
                <option value="completed">å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="filter-lbl">æœƒè­°å®¤</span>
              <select class="filter-select" id="fil-room" onchange="loadBookings()">
                <option value="">å…¨éƒ¨</option>
              </select>
            </div>
          </div>
          <div class="tbl-wrap">
            <table>
              <thead><tr>
                <th>é ç´„ç·¨è™Ÿ</th><th>è¯çµ¡äºº</th><th>éƒ¨é–€</th><th>æœƒè­°å®¤</th>
                <th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>æ™‚é•·</th><th>äººæ•¸</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th>
              </tr></thead>
              <tbody id="bookings-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ROOMS â”€â”€ -->
    <div class="page" id="page-rooms">
      <div class="card">
        <div class="card-head">
          <div class="card-title">æœƒè­°å®¤ç®¡ç†</div>
          <button class="btn btn-primary" onclick="openRoomModal()">ï¼‹ æ–°å¢æœƒè­°å®¤</button>
        </div>
        <div class="card-body">
          <div class="room-admin-grid" id="roomAdminGrid">
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ SITE CONTENT â”€â”€ -->
    <div class="page" id="page-content">
      <div class="card">
        <div class="card-head">
          <div class="card-title">å‰å°æ–‡å­—å…§å®¹ç·¨è¼¯</div>
          <button class="btn btn-primary" onclick="saveContent()">å„²å­˜æ‰€æœ‰è®Šæ›´</button>
        </div>
        <div class="card-body">
          <div class="content-sections">
            <div class="content-section" style="grid-column:1/-1;">
              <div class="cs-head">ä¸»é  Hero å€å¡Š</div>
              <div class="cs-body">
                <div class="fgrid">
                  <div class="cs-field">
                    <label class="cs-label">ç¶²ç«™æ¨™é¡Œï¼ˆç€è¦½å™¨åˆ†é  / Logoï¼‰</label>
                    <input class="finput" type="text" id="c-site_title" placeholder="æœƒè­°å®¤é ç´„ç³»çµ±">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">æ¨™èªå°æ¨™ç±¤ï¼ˆHero Badgeï¼‰</label>
                    <input class="finput" type="text" id="c-hero_badge" placeholder="å°ˆæ¥­æœƒè­°ç©ºé–“">
                  </div>
                  <div class="cs-field" style="grid-column:1/-1;">
                    <label class="cs-label">ä¸»æ¨™é¡Œï¼ˆæ”¯æ´ &lt;em&gt; å¼·èª¿è‰²ï¼‰</label>
                    <input class="finput" type="text" id="c-site_subtitle" placeholder="ä¼æ¥­&lt;em&gt;æœƒè­°å®¤&lt;/em&gt;&lt;br&gt;å³æ™‚é ç´„">
                  </div>
                  <div class="cs-field" style="grid-column:1/-1;">
                    <label class="cs-label">Hero å‰¯æ¨™èªªæ˜æ–‡å­—</label>
                    <textarea class="ftarea" id="c-site_description" rows="2"></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="content-section">
              <div class="cs-head">é ç´„æ­¥é©Ÿæ¨™é¡Œ</div>
              <div class="cs-body">
                <div class="cs-field"><label class="cs-label">Step 1 æ¨™é¡Œ</label><input class="finput" type="text" id="c-step1_title"></div>
                <div class="cs-field"><label class="cs-label">Step 2 æ¨™é¡Œ</label><input class="finput" type="text" id="c-step2_title"></div>
                <div class="cs-field"><label class="cs-label">Step 3 æ¨™é¡Œ</label><input class="finput" type="text" id="c-step3_title"></div>
              </div>
            </div>
            <div class="content-section">
              <div class="cs-head">è¯çµ¡èˆ‡æœå‹™è³‡è¨Š</div>
              <div class="cs-body">
                <div class="cs-field"><label class="cs-label">æœå‹™æ™‚é–“</label><input class="finput" type="text" id="c-service_hours"></div>
                <div class="cs-field"><label class="cs-label">è¯çµ¡é›»è©±</label><input class="finput" type="text" id="c-contact_phone"></div>
                <div class="cs-field"><label class="cs-label">è¯çµ¡ Email</label><input class="finput" type="email" id="c-contact_email"></div>
                <div class="cs-field"><label class="cs-label">é å°¾ç‰ˆæ¬Šæ–‡å­—</label><input class="finput" type="text" id="c-footer_text"></div>
              </div>
            </div>
            <div class="content-section" style="grid-column:1/-1;">
              <div class="cs-head">é ç´„é ˆçŸ¥ï¼ˆæœ€å¤š 5 æ¢ï¼‰</div>
              <div class="cs-body">
                <div class="fgrid">
                  <div class="cs-field"><label class="cs-label">é ˆçŸ¥ 1</label><input class="finput" type="text" id="c-notice_1"></div>
                  <div class="cs-field"><label class="cs-label">é ˆçŸ¥ 2</label><input class="finput" type="text" id="c-notice_2"></div>
                  <div class="cs-field"><label class="cs-label">é ˆçŸ¥ 3</label><input class="finput" type="text" id="c-notice_3"></div>
                  <div class="cs-field"><label class="cs-label">é ˆçŸ¥ 4</label><input class="finput" type="text" id="c-notice_4"></div>
                  <div class="cs-field"><label class="cs-label">é ˆçŸ¥ 5</label><input class="finput" type="text" id="c-notice_5"></div>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top:20px;text-align:right;">
            <button class="btn btn-primary" onclick="saveContent()" style="padding:12px 28px;font-size:15px;">å„²å­˜æ‰€æœ‰è®Šæ›´</button>
          </div>
          <div style="margin-top:28px;padding:20px;background:var(--paper);border-radius:8px;border:1px solid var(--border);">
            <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink);margin-bottom:12px;">é€šçŸ¥æœå‹™è¨­å®šï¼ˆRender ç’°å¢ƒè®Šæ•¸ï¼‰</div>
            <div style="font-size:13px;color:var(--ink-60);line-height:1.9;">
              ä»¥ä¸‹è¨­å®šéœ€åœ¨ <strong>Render â†’ Environment</strong> é é¢å¡«å…¥ï¼š<br>
              <strong style="color:var(--ink);">Emailï¼ˆäºŒé¸ä¸€ï¼‰</strong><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">SENDGRID_API_KEY</code> â€” SendGrid API Key<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">MAIL_FROM</code> â€” å¯„ä»¶äººåœ°å€<br>
              <span style="color:#888;font-size:12px;">â€” æˆ– â€”</span><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">GMAIL_USER</code> â€” Gmail å¸³è™Ÿ<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">GMAIL_APP_PASS</code> â€” Gmail æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼<br>
              <br><strong style="color:var(--ink);">SMS ç°¡è¨Š</strong><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_SID</code> / <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_TOKEN</code> / <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_FROM</code><br>
              <span style="color:var(--green);font-size:12px;">æœªå¡«å…¥å‰‡ç•¥éï¼Œä¸å½±éŸ¿é ç´„åŠŸèƒ½ã€‚</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ PHOTOS â”€â”€ -->
    <div class="page" id="page-photos">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div class="card-title">ç³»çµ± Logo</div>
          <div style="font-size:13px;color:var(--ink-60);">æ›´æ›å¾Œå°èˆ‡å‰å°å·¦ä¸Šè§’ Logo</div>
        </div>
        <div class="card-body">
          <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
            <div id="logoPreviewWrap" style="width:80px;height:80px;border-radius:12px;background:#111;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--gold);flex-shrink:0;overflow:hidden;">
              <span id="logoPreviewText">MR</span>
            </div>
            <div style="flex:1;min-width:200px;">
              <label class="btn btn-outline" style="cursor:pointer;display:inline-block;">
                <input type="file" accept="image/*" style="display:none;" onchange="uploadLogo(event)">
                &#128247; é¸æ“‡ Logo åœ–ç‰‡
              </label>
              <div style="font-size:12px;color:var(--ink-60);margin-top:8px;">æ”¯æ´ JPGã€PNGã€WEBPï¼Œå»ºè­°å°ºå¯¸ 80Ã—80px ä»¥ä¸Šï¼Œæœ€å¤§ 16MB</div>
            </div>
            <div id="logoUploadStatus" style="font-size:13px;color:var(--teal);display:none;">ä¸Šå‚³ä¸­...</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head">
          <div class="card-title">æœƒè­°å®¤ç…§ç‰‡ç®¡ç†</div>
          <div style="font-size:13px;color:var(--ink-60);">æ¯é–“æœ€å¤š 5 å¼µï¼Œå¯è¨­å®šä¸»å°é¢</div>
        </div>
        <div class="card-body">
          <div id="photoRoomList"><div style="text-align:center;padding:40px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ FORM FIELDS â”€â”€ -->
    <div class="page" id="page-formfields">
      <div class="card">
        <div class="card-head">
          <div class="card-title">è¡¨å–®æ¬„ä½ç®¡ç†</div>
          <button class="btn btn-primary btn-sm" onclick="addFormField()">+ æ–°å¢æ¬„ä½</button>
        </div>
        <div class="card-body">
          <div style="font-size:13px;color:var(--ink-60);margin-bottom:16px;">
            æ‹–æ›³å¯èª¿æ•´é †åºãƒ»ç³»çµ±æ¬„ä½ï¼ˆå§“å/æ‰‹æ©Ÿ/Emailï¼‰ç„¡æ³•åˆªé™¤ãƒ»å¿…å¡«æ¬„ä½æœªå¡«ç„¡æ³•é€å‡º
          </div>
          <div id="ffList" style="display:flex;flex-direction:column;gap:10px;"></div>
          <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="btn btn-primary" onclick="saveFormFields()">å„²å­˜è®Šæ›´</button>
            <button class="btn btn-outline" onclick="resetFormFields()">é‚„åŸé è¨­</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ BLOCKED SLOTS â”€â”€ -->
    <div class="page" id="page-blocked">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head"><div class="card-title">æ–°å¢å°é–æ™‚æ®µ</div></div>
        <div class="card-body">
          <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;">
            <div style="min-width:140px;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">æ—¥æœŸ</label>
              <input type="date" class="finput" id="bl-date" style="padding:8px;">
            </div>
            <div style="min-width:110px;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">é–‹å§‹æ™‚é–“</label>
              <select class="fselect" id="bl-start" style="padding:8px;" onchange="updateBlEndOptions()"></select>
            </div>
            <div style="min-width:110px;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">çµæŸæ™‚é–“</label>
              <select class="fselect" id="bl-end" style="padding:8px;"></select>
            </div>
            <div style="min-width:160px;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">æœƒè­°å®¤</label>
              <select class="fselect" id="bl-room" style="padding:8px;">
                <option value="">å…¨é¤¨ï¼ˆæ‰€æœ‰æœƒè­°å®¤ï¼‰</option>
              </select>
            </div>
            <div style="flex:1;min-width:200px;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">åŸå› ï¼ˆé¸å¡«ï¼‰</label>
              <input type="text" class="finput" id="bl-reason" placeholder="ä¾‹ï¼šæ¸…æ½”ç¶­è­·ã€å ´åœ°æ•´ä¿®..." style="padding:8px;">
            </div>
            <div>
              <button class="btn btn-primary" onclick="addBlockedSlot()" style="white-space:nowrap;">+ æ–°å¢å°é–</button>
            </div>
          </div>
          <div style="margin-top:8px;height:20px;">
            <span id="blAddStatus" style="font-size:13px;color:var(--teal);display:none;"></span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head">
          <div class="card-title">å°é–æ™‚æ®µåˆ—è¡¨</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="date" class="finput" id="bl-filter-from" style="padding:6px 8px;font-size:13px;" onchange="loadBlockedSlots()">
            <span style="color:var(--ink-60);">è‡³</span>
            <input type="date" class="finput" id="bl-filter-to" style="padding:6px 8px;font-size:13px;" onchange="loadBlockedSlots()">
            <button class="btn btn-outline btn-sm" onclick="clearBlFilter()">æ¸…é™¤</button>
          </div>
        </div>
        <div class="card-body">
          <div id="blList"><div style="text-align:center;padding:40px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ACCOUNTS â”€â”€ -->
    <div class="page" id="page-accounts">
      <div class="card">
        <div class="card-head">
          <div class="card-title">å¸³è™Ÿç®¡ç†</div>
          <button class="btn btn-primary btn-sm" onclick="openAddAccount()">ï¼‹ æ–°å¢å¸³è™Ÿ</button>
        </div>
        <div class="card-body">
          <div id="accountList"><div style="text-align:center;padding:40px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ LOGIN LOGS â”€â”€ -->
    <div class="page" id="page-logs">
      <div class="card">
        <div class="card-head">
          <div class="card-title">ç™»å…¥ç´€éŒ„</div>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div id="lastLoginInfo" style="font-size:12px;color:var(--ink-60);"></div>
            <button class="btn btn-outline btn-sm" onclick="loadLoginLogs()">é‡æ–°è¼‰å…¥</button>
          </div>
        </div>
        <div class="card-body">
          <!-- ç¯©é¸åˆ— -->
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center;">
            <div class="filter-group">
              <span class="filter-lbl">å¸³è™Ÿ</span>
              <input type="text" class="filter-input" id="log-fil-user" placeholder="æœå°‹å¸³è™Ÿ..." style="width:140px;" oninput="loadLoginLogs()">
            </div>
            <div class="filter-group">
              <span class="filter-lbl">çµæœ</span>
              <select class="filter-select" id="log-fil-result" onchange="loadLoginLogs()">
                <option value="">å…¨éƒ¨</option>
                <option value="1">âœ“ æˆåŠŸ</option>
                <option value="0">âœ— å¤±æ•—</option>
              </select>
            </div>
            <button class="btn btn-outline btn-sm" onclick="clearLogFilters()">æ¸…é™¤ç¯©é¸</button>
          </div>
          <div id="loginLogList"><div style="text-align:center;padding:40px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Room Modal -->
<div class="modal" id="roomModal">
  <div class="modal-box">
    <div class="modal-title" id="roomModalTitle">æ–°å¢æœƒè­°å®¤</div>
    <input type="hidden" id="rm-id">
    <div class="fgrid">
      <div class="fg">
        <label>æœƒè­°å®¤åç¨±</label>
        <input class="finput" type="text" id="rm-name" placeholder="ä¾‹ï¼šç²¾ç·»æ´½è«‡å®¤ A">
      </div>
      <div class="fg">
        <label>é¡å‹</label>
        <select class="fselect" id="rm-type">
          <option>è…¦åŠ›æ¿€ç›ª</option><option>æ´½è«‡å®¤</option><option>ç°¡å ±å»³</option>
          <option>è¦–è¨Šæœƒè­°</option><option>è¡Œæ”¿å¥—æˆ¿</option><option>åŸ¹è¨“æ•™å®¤</option>
        </select>
      </div>
      <div class="fg">
        <label>å®¹ç´äººæ•¸</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="finput" type="number" id="rm-capacity-min" placeholder="æœ€å°‘ï¼ˆé¸å¡«ï¼‰" min="1" style="flex:1;">
          <span style="color:var(--ink-60);white-space:nowrap;">ï½</span>
          <input class="finput" type="number" id="rm-capacity" placeholder="æœ€å¤š" min="1" style="flex:1;">
          <span style="color:var(--ink-60);white-space:nowrap;">äºº</span>
        </div>
        <div style="font-size:12px;color:var(--ink-60);margin-top:4px;">å¡«å¯«æœ€å°‘äººæ•¸å¯é¡¯ç¤ºã€Œ4ï½6 äººã€ç¯„åœ</div>
      </div>
      <div class="fg">
        <label>æ¯å°æ™‚è²»ç‡ï¼ˆNT$ï¼‰</label>
        <input class="finput" type="number" id="rm-rate" placeholder="500" min="0">
      </div>
      <div class="fg">
        <label>æœ€ä½é ç´„æ™‚æ•¸ <span>ï¼ˆ0 = ä¸é™ï¼‰</span></label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input class="finput" type="number" id="rm-min-hours" placeholder="1" min="0" step="0.5" style="flex:1;">
          <span style="color:var(--ink-60);white-space:nowrap;">å°æ™‚</span>
        </div>
      </div>
      <div class="fg">
        <label>æ¨“å±¤</label>
        <input class="finput" type="text" id="rm-floor" placeholder="ä¾‹ï¼š3F">
      </div>
      <div class="fg">
        <label>ç‹€æ…‹</label>
        <select class="fselect" id="rm-active">
          <option value="true">å•Ÿç”¨</option><option value="false">åœç”¨</option>
        </select>
      </div>
    </div>
    <div class="fg">
      <label>æè¿°èªªæ˜</label>
      <textarea class="ftarea" id="rm-desc" placeholder="è©³ç´°æè¿°æ­¤æœƒè­°å®¤çš„ç‰¹è‰²..." rows="4" style="min-height:100px;"></textarea>
    </div>
    <div class="fg">
      <label>è¨­å‚™è¨­æ–½ <span>ï¼ˆè¼¸å…¥å¾ŒæŒ‰ Enter æ–°å¢ï¼‰</span></label>
      <div class="amenity-input-row">
        <input class="finput" type="text" id="rm-amenity-input" placeholder="ä¾‹ï¼šç™½æ¿ã€æŠ•å½±æ©Ÿã€WiFi" onkeydown="amenityKeydown(event)" style="flex:1;">
        <button class="btn btn-outline btn-sm" onclick="addAmenity()">æ–°å¢</button>
      </div>
      <div class="amenity-tags" id="amenityTags"></div>
    </div>
    <div class="fg">
      <label>å°é¢ç…§ç‰‡</label>
      <div class="current-photo-row" id="currentPhotoRow" style="display:none;">
        <img id="currentPhotoThumb" src="" alt="ç›®å‰ç…§ç‰‡">
        <span>ç›®å‰ç…§ç‰‡</span>
        <button class="btn btn-outline btn-sm" onclick="clearModalPhoto()">ç§»é™¤</button>
      </div>
      <div class="photo-upload-area" id="modalUploadArea" onclick="triggerModalFileInput()">
        <input type="file" id="modalPhotoInput" accept="image/*" onchange="handleModalPhotoSelect(event)" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
        <div class="photo-upload-icon">&#9728;</div>
        <div class="photo-upload-text">
          <strong>é»æ“Šé¸æ“‡ç…§ç‰‡</strong> æˆ–æ‹–æ›³åˆ°æ­¤è™•<br>
          <small style="color:var(--ink-60);">æ”¯æ´ JPGã€PNGã€GIFã€WEBPï¼Œæœ€å¤§ 16MB</small>
        </div>
        <div class="upload-progress" id="modalUploadProgress">
          <div class="upload-progress-bar" id="modalUploadBar" style="width:0%"></div>
        </div>
      </div>
      <div id="modalPhotoPreview"></div>
      <input type="hidden" id="rm-photo-url">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeRoomModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveRoom()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Account Modal -->
<div class="modal" id="accountModal">
  <div class="modal-box" style="max-width:560px;">
    <div class="modal-title" id="accountModalTitle">æ–°å¢å¸³è™Ÿ</div>
    <input type="hidden" id="acc-id">
    <div class="fgrid">
      <div class="fg">
        <label>å¸³è™Ÿ <span>ï¼ˆç™»å…¥ç”¨ï¼‰</span></label>
        <input class="finput" id="acc-username" placeholder="ä¾‹ï¼šjohn" autocomplete="off">
      </div>
      <div class="fg">
        <label>é¡¯ç¤ºåç¨±</label>
        <input class="finput" id="acc-display" placeholder="ä¾‹ï¼šç‹å°æ˜">
      </div>
      <div class="fg">
        <label>å¯†ç¢¼ <span id="acc-pw-hint">ï¼ˆæ–°å¢æ™‚å¿…å¡«ï¼‰</span></label>
        <div style="position:relative;">
          <input class="finput" type="password" id="acc-pw" autocomplete="new-password" style="padding-right:44px;">
          <button type="button" onclick="togglePwVis()" title="é¡¯ç¤º/éš±è—å¯†ç¢¼"
            style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:18px;color:var(--ink-60);line-height:1;" id="acc-pw-eye">ğŸ‘</button>
        </div>
      </div>
      <div class="fg">
        <label>è§’è‰²</label>
        <select class="fselect" id="acc-role" onchange="onRoleChange()">
          <option value="superadmin">è¶…ç´šç®¡ç†å“¡</option>
          <option value="admin">ç®¡ç†å“¡</option>
          <option value="manager" selected>åº—é•·/ç¶“ç†</option>
          <option value="staff">é–€å¸‚äººå“¡</option>
        </select>
      </div>
      <div class="fg">
        <label>ç‹€æ…‹</label>
        <select class="fselect" id="acc-active">
          <option value="true">å•Ÿç”¨</option>
          <option value="false">åœç”¨</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px;">
      <div style="font-size:13px;font-weight:600;margin-bottom:6px;">åŠŸèƒ½æ¬Šé™ <span style="font-weight:400;color:var(--ink-60);font-size:12px;">ï¼ˆè¶…ç´šç®¡ç†å“¡è‡ªå‹•æ“æœ‰å…¨éƒ¨ï¼‰</span></div>
      <div id="accPermGrid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:14px;background:var(--paper);border-radius:6px;border:1px solid var(--border);"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeAccountModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveAccount()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const PW = sessionStorage.getItem('adminPw') || '';
if (!PW) window.location.href = '/admin';

const H = { 'X-Admin-Password': PW };
let amenities = [];
let allRooms = [];

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 3000);
}

function showPage(id, navEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
  const titles = {
    dashboard: 'å„€è¡¨æ¿', bookings: 'é ç´„ç®¡ç†', rooms: 'æœƒè­°å®¤ç®¡ç†',
    content: 'æ–‡å­—å…§å®¹ç·¨è¼¯', photos: 'ç…§ç‰‡ç®¡ç†', formfields: 'è¡¨å–®æ¬„ä½ç®¡ç†',
    blocked: 'å°é–æ™‚æ®µç®¡ç†', accounts: 'å¸³è™Ÿç®¡ç†', logs: 'ç™»å…¥ç´€éŒ„'
  };
  document.getElementById('topbarTitle').textContent = titles[id] || '';
  switch(id) {
    case 'dashboard': initFloorDate(); loadDashboard(); loadFloorStatus(); break;
    case 'bookings': loadBookings(); break;
    case 'rooms': loadRoomsAdmin(); break;
    case 'content': loadContent(); break;
    case 'photos': loadPhotos(); break;
    case 'formfields': loadFormFields(); break;
    case 'blocked': loadBlockedSlots(); break;
    case 'accounts': loadAccounts(); break;
    case 'logs': loadLoginLogs(); break;
  }
}

function logout() {
  fetch('/admin/api/logout', {method:'POST', headers:H}).catch(()=>{});
  sessionStorage.clear();
  window.location.href = '/admin';
}

// â”€â”€ DASHBOARD â”€â”€
function initFloorDate() {
  const el = document.getElementById('floor-date');
  if (el && !el.value) el.value = new Date().toISOString().split('T')[0];
}

async function loadFloorStatus() {
  const dateEl = document.getElementById('floor-date');
  const date = dateEl ? dateEl.value : new Date().toISOString().split('T')[0];
  const board = document.getElementById('floor-board');
  if (!board) return;
  board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink-60);">è¼‰å…¥ä¸­...</div>';
  try {
    const res = await fetch(`/admin/api/floor-status?date=${date}`, { headers: H });
    const data = await res.json();
    if (!data.rooms || !data.rooms.length) {
      board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink-60);">ç„¡æœƒè­°å®¤è³‡æ–™</div>';
      return;
    }
    const now = new Date();
    const nowDate = now.toISOString().split('T')[0];
    const isToday = date === nowDate;
    const nowSlot = isToday ? Math.floor((now.getHours() * 60 + now.getMinutes() - 480) / 30) : -1;
    const ticks = [];
    for (let i = 0; i < 28; i++) { ticks.push(i % 2 === 0 ? `${8 + Math.floor(i/2)}:00` : ''); }
    const floors = {};
    data.rooms.forEach(r => { const f = r.floor || 'æœªåˆ†å±¤'; if (!floors[f]) floors[f] = []; floors[f].push(r); });
    const floorOrder = Object.keys(floors).sort((a, b) => (parseInt(a)||0) - (parseInt(b)||0));
    const axisHtml = `<div class="time-axis">${ticks.map(t => `<div class="time-tick">${t}</div>`).join('')}</div>`;
    let html = axisHtml;
    floorOrder.forEach(floor => {
      html += `<div class="floor-section"><div class="floor-label">${floor}</div>`;
      floors[floor].forEach(r => {
        const slotBookings = new Array(28).fill(null);
        r.bookings.forEach(b => {
          const sh = parseInt(b.start.split(':')[0]), sm = parseInt(b.start.split(':')[1]);
          const eh = parseInt(b.end.split(':')[0]),   em = parseInt(b.end.split(':')[1]);
          const si = (sh * 60 + sm - 480) / 30, ei = (eh * 60 + em - 480) / 30;
          for (let i = Math.max(0,si); i < Math.min(28,ei); i++) slotBookings[i] = b;
        });
        const cells = r.slots.map((booked, i) => {
          let cls = 'free';
          if (i < nowSlot) cls = 'past';
          else if (i === nowSlot) cls = booked ? 'now-booked' : 'now-free';
          else if (booked) cls = 'booked';
          const startH = 8 + Math.floor(i / 2), startM = (i % 2) * 30;
          const endH = startH + (startM === 30 ? 1 : 0), endM = startM === 30 ? 0 : 30;
          const timeLabel = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')}â€“${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
          let tip = timeLabel;
          if (booked && slotBookings[i]) tip = `${timeLabel}ï½œ${slotBookings[i].name}ï¼ˆ${slotBookings[i].number}ï¼‰`;
          return `<div class="slot-cell ${cls}" title="${tip}"></div>`;
        }).join('');
        html += `<div class="room-row"><div class="room-row-info"><div class="room-row-name" title="${r.name}">${r.name}</div><div class="room-row-cap">${r.room_type} Â· ${r.capacity_label || r.capacity + ' äºº'}</div></div><div class="slots-wrap">${cells}</div></div>`;
      });
      html += `</div>`;
    });
    board.innerHTML = html;
  } catch(e) {
    board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--red);">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
    console.error(e);
  }
}

async function loadDashboard() {
  try {
    const statsRes = await fetch('/admin/api/stats', { headers: H });
    const stats = await statsRes.json();
    document.getElementById('st-total').textContent = stats.total_bookings;
    document.getElementById('st-today').textContent = stats.today_bookings;
    document.getElementById('st-rooms').textContent = stats.total_rooms;
    document.getElementById('st-revenue').textContent = 'NT$' + (stats.total_revenue || 0).toLocaleString();
    document.getElementById('st-cancelled').textContent = stats.cancelled;
    document.getElementById('st-completed').textContent = stats.completed;
    const rr = await fetch('/admin/api/rooms', { headers: H });
    const rooms = await rr.json();
    const sel = document.getElementById('dash-fil-room');
    if (sel && sel.options.length <= 1) {
      rooms.forEach(r => { const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name; sel.appendChild(opt); });
    }
  } catch(e) { console.error(e); }
  try {
    const sc = await (await fetch('/api/site-content', { headers: H })).json();
    if (sc.logo_url) applyLogo(sc.logo_url);
  } catch(e) {}
  loadDashboardBookings();
  loadCurrentUser();
}

async function loadDashboardBookings() {
  try {
    const date   = document.getElementById('dash-fil-date')?.value || '';
    const status = document.getElementById('dash-fil-status')?.value || '';
    const room   = document.getElementById('dash-fil-room')?.value || '';
    let url = '/admin/api/bookings?';
    if (date)   url += `date=${date}&`;
    if (status) url += `status=${status}&`;
    if (room)   url += `room_id=${room}&`;
    const res = await fetch(url, { headers: H });
    const bookings = await res.json();
    const tbody = document.getElementById('dash-bookings');
    if (!bookings.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--ink-60);">æ‰¾ä¸åˆ°ç¬¦åˆçš„é ç´„</td></tr>';
      return;
    }
    tbody.innerHTML = bookings.slice(0, 20).map(b => `
      <tr>
        <td><strong>${b.booking_number}</strong></td>
        <td>${b.customer_name}</td>
        <td>${b.room_name}</td>
        <td>${b.date}</td>
        <td>${fmtSegments(b)}</td>
        <td>${badgeHtml(b.status)}</td>
        <td>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            ${b.status==='confirmed'?`<button class="btn btn-danger btn-sm" onclick="cancelBooking(${b.id})">å–æ¶ˆ</button>`:''}
            <button class="btn btn-sm" onclick="deleteBooking(${b.id})" style="background:#6b3a2a;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:4px 10px;font-size:12px;">åˆªé™¤</button>
          </div>
        </td>
      </tr>`).join('');
  } catch(e) { console.error(e); }
}

function clearDashFilters() {
  ['dash-fil-date','dash-fil-status','dash-fil-room'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  loadDashboardBookings();
}

// â”€â”€ BOOKINGS â”€â”€
async function loadBookings() {
  try {
    if (!allRooms.length) {
      const rr = await fetch('/admin/api/rooms', { headers: H });
      allRooms = await rr.json();
    }
    const sel = document.getElementById('fil-room');
    if (sel.options.length < 2) {
      allRooms.forEach(r => { const opt = document.createElement('option'); opt.value = r.id; opt.textContent = r.name; sel.appendChild(opt); });
    }
    const date = document.getElementById('fil-date').value;
    const status = document.getElementById('fil-status').value;
    const room = document.getElementById('fil-room').value;
    let url = '/admin/api/bookings?';
    if (date) url += `date=${date}&`;
    if (status) url += `status=${status}&`;
    if (room) url += `room_id=${room}`;
    const res = await fetch(url, { headers: H });
    const bookings = await res.json();
    const tbody = document.getElementById('bookings-tbody');
    if (!bookings.length) {
      tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:30px;color:var(--ink-60);">æ‰¾ä¸åˆ°ç¬¦åˆçš„é ç´„</td></tr>';
      return;
    }
    tbody.innerHTML = bookings.map(b => `
      <tr>
        <td><strong>${b.booking_number}</strong></td>
        <td>${b.customer_name}<br><small style="color:var(--ink-60);">${b.customer_phone}</small></td>
        <td>${b.department || 'â€”'}</td>
        <td>${b.room_name}</td>
        <td>${b.date}</td>
        <td>${fmtSegments(b)}</td>
        <td>${b.duration}h</td>
        <td>${b.attendees}äºº</td>
        <td>NT$ ${(b.total_price||0).toLocaleString()}</td>
        <td>${badgeHtml(b.status)}</td>
        <td>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            ${b.status === 'confirmed' ? `
              <button class="btn btn-outline btn-sm" onclick="completeBooking(${b.id})">å®Œæˆ</button>
              <button class="btn btn-danger btn-sm" onclick="cancelBooking(${b.id})">å–æ¶ˆ</button>
            ` : ''}
            <button class="btn btn-danger btn-sm" onclick="deleteBooking(${b.id})" title="æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„" style="opacity:0.7;">åˆªé™¤</button>
          </div>
        </td>
      </tr>`).join('');
  } catch(e) { console.error(e); }
}

async function cancelBooking(id) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤é ç´„ï¼Ÿ')) return;
  const res = await fetch(`/admin/api/bookings/${id}/cancel`, { method: 'POST', headers: H });
  if (res.ok) { toast('é ç´„å·²å–æ¶ˆ'); loadBookings(); }
  else toast('æ“ä½œå¤±æ•—', 'error');
}

async function completeBooking(id) {
  if (!confirm('ç¢ºå®šå°‡æ­¤é ç´„æ¨™è¨˜ç‚ºå®Œæˆï¼Ÿ')) return;
  const res = await fetch(`/admin/api/bookings/${id}/complete`, { method: 'POST', headers: H });
  if (res.ok) { toast('å·²æ¨™è¨˜ç‚ºå®Œæˆ'); loadBookings(); }
  else toast('æ“ä½œå¤±æ•—', 'error');
}

async function deleteBooking(id) {
  if (!confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤æ­¤é ç´„ç´€éŒ„ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
  const res = await fetch(`/admin/api/bookings/${id}`, { method: 'DELETE', headers: H });
  if (res.ok) { toast('é ç´„ç´€éŒ„å·²åˆªé™¤'); loadBookings(); }
  else toast('åˆªé™¤å¤±æ•—', 'error');
}

// â”€â”€ ROOMS ADMIN â”€â”€
async function loadRoomsAdmin() {
  try {
    const res = await fetch('/admin/api/rooms', { headers: H });
    allRooms = await res.json();
    const ICONS = {'è…¦åŠ›æ¿€ç›ª':'BS','æ´½è«‡å®¤':'MT','ç°¡å ±å»³':'PR','è¦–è¨Šæœƒè­°':'VC','è¡Œæ”¿å¥—æˆ¿':'EX','åŸ¹è¨“æ•™å®¤':'TR'};
    document.getElementById('roomAdminGrid').innerHTML = allRooms.map(r => {
      const icon = ICONS[r.room_type] || 'MR';
      const photoHTML = r.photo_url
        ? `<div class="rac-photo" style="position:relative;"><img src="${r.photo_url}" alt="${r.name}" onerror="this.parentElement.innerHTML='<div class=rac-photo-placeholder>${icon}</div>'"><span class="rac-status ${r.is_active ? 'badge-green' : 'badge-red'}">${r.is_active ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨'}</span></div>`
        : `<div class="rac-photo-placeholder" style="position:relative;">${icon}<span class="rac-status badge-gray" style="position:absolute;top:8px;right:8px;">${r.is_active ? 'å•Ÿç”¨ä¸­' : 'å·²åœç”¨'}</span></div>`;
      return `
        <div class="room-admin-card ${r.is_active ? '' : 'inactive'}">
          ${photoHTML}
          <div class="rac-body">
            <div class="rac-type">${r.room_type}</div>
            <div class="rac-name">${r.name}</div>
            <div class="rac-meta">å®¹ç´ ${r.capacity_label || r.capacity + ' äºº'} Â· ${r.floor || 'Fâ€”'} Â· NT$ ${r.hourly_rate.toLocaleString()}/hr${r.min_hours>0?' Â· æœ€å°‘ '+(r.min_hours===Math.floor(r.min_hours)?r.min_hours:r.min_hours)+' å°æ™‚':''}</div>
            ${r.description ? `<div class="rac-desc">${r.description.length > 60 ? r.description.slice(0,60) + 'â€¦' : r.description}</div>` : ''}
            <div class="rac-actions">
              <button class="btn btn-outline btn-sm" onclick="editRoom(${r.id})" style="flex:1;">ç·¨è¼¯</button>
              <button class="btn btn-outline btn-sm" onclick="toggleRoomStatus(${r.id}, ${!r.is_active})" style="flex:1;">${r.is_active ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
            </div>
          </div>
        </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

async function toggleRoomStatus(id, newActive) {
  const res = await fetch(`/admin/api/rooms/${id}`, { method: 'PUT', headers: { ...H, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_active: newActive }) });
  if (res.ok) { toast(newActive ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'); loadRoomsAdmin(); }
  else toast('æ“ä½œå¤±æ•—', 'error');
}

// â”€â”€ ROOM MODAL â”€â”€
function openRoomModal() {
  document.getElementById('rm-id').value = '';
  document.getElementById('rm-name').value = '';
  document.getElementById('rm-type').value = 'æ´½è«‡å®¤';
  document.getElementById('rm-capacity').value = '';
  document.getElementById('rm-capacity-min').value = '';
  document.getElementById('rm-rate').value = '';
  document.getElementById('rm-floor').value = '';
  document.getElementById('rm-desc').value = '';
  document.getElementById('rm-active').value = 'true';
  document.getElementById('rm-min-hours').value = '1';
  document.getElementById('rm-photo-url').value = '';
  document.getElementById('currentPhotoRow').style.display = 'none';
  document.getElementById('modalPhotoPreview').innerHTML = '';
  amenities = [];
  renderAmenities();
  document.getElementById('roomModalTitle').textContent = 'æ–°å¢æœƒè­°å®¤';
  document.getElementById('roomModal').classList.add('show');
}

function editRoom(id) {
  const r = allRooms.find(x => x.id === id);
  if (!r) return;
  document.getElementById('rm-id').value = r.id;
  document.getElementById('rm-name').value = r.name;
  document.getElementById('rm-type').value = r.room_type;
  document.getElementById('rm-capacity').value = r.capacity;
  document.getElementById('rm-capacity-min').value = r.capacity_min || '';
  document.getElementById('rm-rate').value = r.hourly_rate;
  document.getElementById('rm-floor').value = r.floor || '';
  document.getElementById('rm-desc').value = r.description || '';
  document.getElementById('rm-active').value = r.is_active ? 'true' : 'false';
  document.getElementById('rm-min-hours').value = r.min_hours !== undefined ? r.min_hours : 1;
  document.getElementById('rm-photo-url').value = r.photo_url || '';
  amenities = [...(r.amenities || [])];
  renderAmenities();
  const photoRow = document.getElementById('currentPhotoRow');
  if (r.photo_url) { photoRow.style.display = 'flex'; document.getElementById('currentPhotoThumb').src = r.photo_url; }
  else { photoRow.style.display = 'none'; }
  document.getElementById('roomModalTitle').textContent = `ç·¨è¼¯ï¼š${r.name}`;
  document.getElementById('roomModal').classList.add('show');
}

function closeRoomModal() { document.getElementById('roomModal').classList.remove('show'); }

function amenityKeydown(e) { if (e.key === 'Enter') { e.preventDefault(); addAmenity(); } }
function addAmenity() {
  const input = document.getElementById('rm-amenity-input');
  const val = input.value.trim();
  if (val && !amenities.includes(val)) { amenities.push(val); renderAmenities(); }
  input.value = ''; input.focus();
}
function removeAmenity(idx) { amenities.splice(idx, 1); renderAmenities(); }
function renderAmenities() {
  document.getElementById('amenityTags').innerHTML = amenities.map((a, i) =>
    `<span class="amenity-tag">${a} <span class="amenity-remove" onclick="removeAmenity(${i})">Ã—</span></span>`
  ).join('');
}

function triggerModalFileInput() {}
let pendingPhotoUrl = '';

async function handleModalPhotoSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const progress = document.getElementById('modalUploadProgress');
  const bar = document.getElementById('modalUploadBar');
  progress.style.display = 'block'; bar.style.width = '30%';
  const formData = new FormData();
  formData.append('photo', file);
  try {
    bar.style.width = '70%';
    const res = await fetch('/admin/api/upload-photo', { method: 'POST', headers: { 'X-Admin-Password': PW }, body: formData });
    bar.style.width = '100%';
    const data = await res.json();
    if (res.ok && data.photo_url) {
      document.getElementById('rm-photo-url').value = data.photo_url;
      pendingPhotoUrl = data.photo_url;
      document.getElementById('modalPhotoPreview').innerHTML = `<div class="photo-preview"><img src="${data.photo_url}" alt="é è¦½"></div>`;
      document.getElementById('currentPhotoRow').style.display = 'flex';
      document.getElementById('currentPhotoThumb').src = data.photo_url;
      toast('ç…§ç‰‡ä¸Šå‚³æˆåŠŸ');
    } else { toast(data.error || 'ä¸Šå‚³å¤±æ•—', 'error'); }
  } catch { toast('ä¸Šå‚³å¤±æ•—', 'error'); }
  finally { setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 800); }
}

function clearModalPhoto() {
  document.getElementById('rm-photo-url').value = '';
  document.getElementById('currentPhotoRow').style.display = 'none';
  document.getElementById('modalPhotoPreview').innerHTML = '';
  toast('å·²ç§»é™¤ç…§ç‰‡');
}

async function saveRoom() {
  const id = document.getElementById('rm-id').value;
  const payload = {
    name: document.getElementById('rm-name').value.trim(),
    room_type: document.getElementById('rm-type').value,
    capacity: parseInt(document.getElementById('rm-capacity').value) || 10,
    capacity_min: parseInt(document.getElementById('rm-capacity-min').value) || 0,
    hourly_rate: parseInt(document.getElementById('rm-rate').value) || 500,
    floor: document.getElementById('rm-floor').value.trim(),
    description: document.getElementById('rm-desc').value.trim(),
    amenities: amenities,
    is_active: document.getElementById('rm-active').value === 'true',
    min_hours: parseFloat(document.getElementById('rm-min-hours').value) || 0,
    photo_url: document.getElementById('rm-photo-url').value,
  };
  if (!payload.name) { alert('è«‹å¡«å¯«æœƒè­°å®¤åç¨±'); return; }
  try {
    const url = id ? `/admin/api/rooms/${id}` : '/admin/api/rooms';
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, { method, headers: { ...H, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (res.ok) { toast(id ? 'æœƒè­°å®¤å·²æ›´æ–°' : 'æœƒè­°å®¤å·²æ–°å¢'); closeRoomModal(); loadRoomsAdmin(); }
    else { const err = await res.json(); toast(err.error || 'å„²å­˜å¤±æ•—', 'error'); }
  } catch { toast('å„²å­˜å¤±æ•—', 'error'); }
}

// â”€â”€ CONTENT â”€â”€
async function loadContent() {
  try {
    const res = await fetch('/admin/api/site-content', { headers: H });
    const data = await res.json();
    const keys = ['site_title','hero_badge','site_subtitle','site_description',
                  'step1_title','step2_title','step3_title',
                  'service_hours','contact_phone','contact_email','footer_text',
                  'notice_1','notice_2','notice_3','notice_4','notice_5'];
    keys.forEach(k => { const el = document.getElementById(`c-${k}`); if (el && data[k] !== undefined) el.value = data[k]; });
  } catch { toast('è¼‰å…¥å¤±æ•—', 'error'); }
}

async function saveContent() {
  const keys = ['site_title','hero_badge','site_subtitle','site_description',
                'step1_title','step2_title','step3_title',
                'service_hours','contact_phone','contact_email','footer_text',
                'notice_1','notice_2','notice_3','notice_4','notice_5'];
  const payload = {};
  keys.forEach(k => { const el = document.getElementById(`c-${k}`); if (el) payload[k] = el.value.trim(); });
  try {
    const res = await fetch('/admin/api/site-content', { method: 'POST', headers: { ...H, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (res.ok) toast('å·²å„²å­˜ï¼Œå‰å°å°‡å³æ™‚æ›´æ–°');
    else toast('å„²å­˜å¤±æ•—', 'error');
  } catch { toast('å„²å­˜å¤±æ•—', 'error'); }
}

// â”€â”€ PHOTOS â”€â”€
async function loadPhotos() {
  try {
    const res = await fetch('/admin/api/rooms', { headers: H });
    allRooms = await res.json();
    const ICONS = {'è…¦åŠ›æ¿€ç›ª':'BS','æ´½è«‡å®¤':'MT','ç°¡å ±å»³':'PR','è¦–è¨Šæœƒè­°':'VC','è¡Œæ”¿å¥—æˆ¿':'EX','åŸ¹è¨“æ•™å®¤':'TR'};
    document.getElementById('photoRoomList').innerHTML = allRooms.map(r => {
      const icon = ICONS[r.room_type] || 'MR';
      const photos = r.photos || (r.photo_url ? [r.photo_url] : []);
      const coverIdx = r.cover_index || 0;
      const canUpload = photos.length < 5;
      const photoGrid = photos.length > 0
        ? `<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="photo-grid-${r.id}">
            ${photos.map((url, i) => `
              <div style="position:relative;width:120px;flex-shrink:0;">
                <img src="${url}" style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:2px solid ${i===coverIdx?'var(--gold)':'var(--border)'};display:block;">
                ${i===coverIdx ? '<div style="position:absolute;top:4px;left:4px;background:var(--gold);color:#1a1a1a;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;">ä¸»å°é¢</div>' : ''}
                <div style="display:flex;gap:4px;margin-top:4px;">
                  ${i!==coverIdx ? `<button class="btn btn-outline btn-sm" style="flex:1;font-size:11px;padding:3px;" onclick="setCover(${r.id},${i})">è¨­ç‚ºå°é¢</button>` : '<div style="flex:1;text-align:center;font-size:11px;color:var(--gold);">âœ“ å°é¢</div>'}
                  <button class="btn btn-sm" style="background:#c44b3a;color:#fff;border:none;font-size:11px;padding:3px 8px;border-radius:4px;cursor:pointer;" onclick="deletePhoto(${r.id},${i})">âœ•</button>
                </div>
              </div>`).join('')}
          </div>`
        : `<div style="color:var(--ink-60);font-size:13px;margin-bottom:12px;">å°šæœªä¸Šå‚³ç…§ç‰‡</div>`;
      return `
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div style="display:flex;align-items:center;gap:12px;">
            <div><div class="card-title">${r.name}</div><div style="font-size:12px;color:var(--ink-60);">${r.room_type} Â· ${r.floor||'Fâ€”'} Â· ${photos.length}/5 å¼µ</div></div>
          </div>
          <span class="badge ${r.is_active?'badge-green':'badge-gray'}">${r.is_active?'å•Ÿç”¨ä¸­':'å·²åœç”¨'}</span>
        </div>
        <div class="card-body">
          ${photoGrid}
          ${canUpload ? `
          <div class="photo-upload-area" style="position:relative;" id="drop-${r.id}"
            ondragover="dragover(event,${r.id})" ondragleave="dragleave(event,${r.id})" ondrop="handleDrop(event,${r.id})">
            <input type="file" accept="image/*" onchange="uploadRoomPhoto(event,${r.id})" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
            <div class="photo-upload-icon">&#43;</div>
            <div class="photo-upload-text"><strong>æ–°å¢ç…§ç‰‡</strong>ï¼ˆé‚„å¯ä¸Šå‚³ ${5-photos.length} å¼µï¼‰<br><small>JPGã€PNGã€GIFã€WEBPï¼Œæœ€å¤§ 16MB</small></div>
            <div class="upload-progress" id="prog-${r.id}"><div class="upload-progress-bar" id="progbar-${r.id}" style="width:0%"></div></div>
          </div>` : `<div style="color:var(--ink-60);font-size:13px;text-align:center;padding:12px;">å·²é”ä¸Šé™ï¼ˆ5 å¼µï¼‰ï¼Œè«‹å…ˆåˆªé™¤èˆŠç…§ç‰‡å†ä¸Šå‚³</div>`}
        </div>
      </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

function dragover(e, id) { e.preventDefault(); document.getElementById(`drop-${id}`).classList.add('dragover'); }
function dragleave(e, id) { document.getElementById(`drop-${id}`).classList.remove('dragover'); }
function handleDrop(e, id) { e.preventDefault(); document.getElementById(`drop-${id}`).classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file) uploadRoomPhotoFile(file, id); }

async function uploadRoomPhoto(event, roomId) { uploadRoomPhotoFile(event.target.files[0], roomId); }

async function uploadRoomPhotoFile(file, roomId) {
  if (!file) return;
  const prog = document.getElementById(`prog-${roomId}`), bar = document.getElementById(`progbar-${roomId}`);
  if (prog) { prog.style.display = 'block'; bar.style.width = '30%'; }
  const fd = new FormData(); fd.append('photo', file);
  try {
    if (bar) bar.style.width = '70%';
    const res = await fetch(`/admin/api/rooms/${roomId}/photos`, { method: 'POST', headers: { 'X-Admin-Password': PW }, body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'ä¸Šå‚³å¤±æ•—');
    if (bar) bar.style.width = '100%';
    toast('ç…§ç‰‡å·²ä¸Šå‚³');
    setTimeout(() => loadPhotos(), 400);
  } catch(e) { toast(e.message || 'ä¸Šå‚³å¤±æ•—', 'error'); }
  finally { setTimeout(() => { if(prog){prog.style.display='none'; bar.style.width='0%';} }, 1000); }
}

async function deletePhoto(roomId, idx) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) return;
  const res = await fetch(`/admin/api/rooms/${roomId}/photos/${idx}`, { method: 'DELETE', headers: H });
  const data = await res.json();
  if (res.ok) { toast('å·²åˆªé™¤'); loadPhotos(); }
  else toast(data.error || 'åˆªé™¤å¤±æ•—', 'error');
}

async function setCover(roomId, idx) {
  const res = await fetch(`/admin/api/rooms/${roomId}/photos/cover`, { method: 'PUT', headers: { ...H, 'Content-Type': 'application/json' }, body: JSON.stringify({ index: idx }) });
  if (res.ok) { toast('ä¸»å°é¢å·²è¨­å®š'); loadPhotos(); }
  else toast('è¨­å®šå¤±æ•—', 'error');
}

async function uploadLogo(event) {
  const file = event.target.files[0]; if (!file) return;
  const status = document.getElementById('logoUploadStatus');
  status.style.display = 'block'; status.textContent = 'ä¸Šå‚³ä¸­...';
  const fd = new FormData(); fd.append('photo', file);
  try {
    const res = await fetch('/admin/api/site-logo', { method: 'POST', headers: { 'X-Admin-Password': PW }, body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'ä¸Šå‚³å¤±æ•—');
    status.textContent = 'âœ“ å·²æ›´æ–°';
    applyLogo(data.logo_url);
    toast('Logo å·²æ›´æ–°');
  } catch(e) { status.textContent = 'ä¸Šå‚³å¤±æ•—ï¼š' + e.message; toast(e.message, 'error'); }
}

function applyLogo(url) {
  const wrap = document.getElementById('logoPreviewWrap'), icon = document.getElementById('sidebarLogoIcon');
  if (url) {
    if (wrap) wrap.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:contain;border-radius:8px;">`;
    if (icon) icon.innerHTML = `<img src="${url}" style="width:32px;height:32px;object-fit:contain;border-radius:4px;">`;
  }
}

// â”€â”€ FORM FIELDS â”€â”€
const FF_DEFAULT = [
  {id:"name",label:"è¯çµ¡äººå§“å",type:"text",placeholder:"è«‹è¼¸å…¥å§“å",required:true,system:true,full:false},
  {id:"phone",label:"æ‰‹æ©Ÿè™Ÿç¢¼",type:"tel",placeholder:"0912345678",required:true,system:true,full:false},
  {id:"email",label:"Email",type:"email",placeholder:"your@email.com",required:true,system:true,full:false,hint:"å¿…å¡«ï¼Œæ¥æ”¶ç¢ºèªä¿¡"},
  {id:"department",label:"éƒ¨é–€ï¼å…¬å¸",type:"text",placeholder:"ä¾‹ï¼šè¡ŒéŠ·éƒ¨",required:false,system:true,full:false},
  {id:"attendees",label:"é è¨ˆå‡ºå¸­äººæ•¸",type:"select",options:"1,2,3,4,5,6,8,10,15,20,30,50",required:false,system:true,full:false},
  {id:"purpose",label:"æœƒè­°é¡å‹",type:"select",options:"éƒ¨é–€æœƒè­°,å®¢æˆ¶æ´½è«‡,å“¡å·¥åŸ¹è¨“,ç”¢å“ç™¼è¡¨,è¦–è¨Šæœƒè­°,è…¦åŠ›æ¿€ç›ª,å…¶ä»–",required:false,system:true,full:false},
  {id:"note",label:"å‚™è¨»",type:"textarea",placeholder:"ç‰¹æ®Šéœ€æ±‚æˆ–æ³¨æ„äº‹é …...",required:false,system:true,full:true}
];
let _ffFields = [];
let _ffDragIdx = null;

async function loadFormFields() {
  try {
    const sc = await (await fetch('/admin/api/site-content', {headers:H})).json();
    let fields;
    try { fields = sc.form_fields ? JSON.parse(sc.form_fields) : [...FF_DEFAULT]; }
    catch(e) { fields = [...FF_DEFAULT]; }
    _ffFields = fields;
    renderFFList();
  } catch(e) { console.error(e); }
}

function renderFFList() {
  const list = document.getElementById('ffList');
  list.innerHTML = _ffFields.map((f, i) => `
    <div class="card" style="padding:0;border:1px solid var(--border);border-radius:8px;"
      draggable="true" ondragstart="_ffDragStart(${i})" ondragover="_ffDragOver(event,${i})" ondrop="_ffDrop(event,${i})">
      <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;">
        <span style="cursor:grab;color:var(--ink-60);font-size:18px;padding:0 4px;">â ¿</span>
        <div style="flex:1;display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;align-items:center;">
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">æ¬„ä½åç¨±</div>
            <input class="finput" style="padding:6px 8px;font-size:13px;" value="${esc(f.label)}" onchange="_ffUpdate(${i},'label',this.value)">
          </div>
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">é¡å‹</div>
            <select class="fselect" style="padding:6px 8px;font-size:13px;" onchange="_ffUpdate(${i},'type',this.value)" ${f.system?'disabled':''}>
              <option value="text" ${f.type==='text'?'selected':''}>æ–‡å­—</option>
              <option value="tel" ${f.type==='tel'?'selected':''}>é›»è©±</option>
              <option value="email" ${f.type==='email'?'selected':''}>Email</option>
              <option value="number" ${f.type==='number'?'selected':''}>æ•¸å­—</option>
              <option value="select" ${f.type==='select'?'selected':''}>ä¸‹æ‹‰é¸å–®</option>
              <option value="textarea" ${f.type==='textarea'?'selected':''}>å¤šè¡Œæ–‡å­—</option>
            </select>
          </div>
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">${f.type==='select'?'é¸é …ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰':'æç¤ºæ–‡å­—'}</div>
            <input class="finput" style="padding:6px 8px;font-size:13px;" value="${esc(f.type==='select'?(f.options||''):(f.placeholder||''))}"
              onchange="_ffUpdate(${i},f.type==='select'?'options':'placeholder',this.value)">
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:6px;">å¿…å¡«</div>
            <input type="checkbox" ${f.required?'checked':''} onchange="_ffUpdate(${i},'required',this.checked)" ${f.id==='name'||f.id==='phone'||f.id==='email'?'disabled':''}>
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:6px;">å…¨å¯¬</div>
            <input type="checkbox" ${f.full?'checked':''} onchange="_ffUpdate(${i},'full',this.checked)">
          </div>
        </div>
        ${f.system ? '<span style="font-size:11px;color:var(--ink-60);padding:0 8px;white-space:nowrap;">ç³»çµ±</span>'
          : `<button class="btn btn-sm btn-danger" onclick="_ffDelete(${i})">åˆªé™¤</button>`}
      </div>
    </div>`).join('');
}

function esc(s) { return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
function _ffUpdate(i, key, val) { _ffFields[i][key] = val; }
function _ffDelete(i) { if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${_ffFields[i].label}ã€æ¬„ä½ï¼Ÿ`)) return; _ffFields.splice(i, 1); renderFFList(); }
function _ffDragStart(i) { _ffDragIdx = i; }
function _ffDragOver(e, i) { e.preventDefault(); }
function _ffDrop(e, i) { e.preventDefault(); if (_ffDragIdx === null || _ffDragIdx === i) return; const moved = _ffFields.splice(_ffDragIdx, 1)[0]; _ffFields.splice(i, 0, moved); _ffDragIdx = null; renderFFList(); }

function addFormField() {
  _ffFields.push({id: 'custom_' + Date.now(), label: 'æ–°æ¬„ä½', type: 'text', placeholder: '', required: false, system: false, full: false});
  renderFFList();
  document.getElementById('ffList').lastElementChild?.scrollIntoView({behavior:'smooth'});
}

async function saveFormFields() {
  const res = await fetch('/admin/api/site-content', { method: 'POST', headers: {...H, 'Content-Type':'application/json'}, body: JSON.stringify({form_fields: JSON.stringify(_ffFields)}) });
  if (res.ok) toast('è¡¨å–®æ¬„ä½å·²å„²å­˜');
  else toast('å„²å­˜å¤±æ•—', 'error');
}

async function resetFormFields() {
  if (!confirm('ç¢ºå®šé‚„åŸç‚ºé è¨­æ¬„ä½ï¼Ÿ')) return;
  _ffFields = JSON.parse(JSON.stringify(FF_DEFAULT));
  renderFFList();
  await saveFormFields();
}

// â”€â”€ BLOCKED SLOTS â”€â”€
const SLOT_TIMES = [];
for (let h = 8; h < 22; h++) { SLOT_TIMES.push(`${String(h).padStart(2,'0')}:00`); SLOT_TIMES.push(`${String(h).padStart(2,'0')}:30`); }
SLOT_TIMES.push('22:00');

function initBlTimeSelects() {
  const startSel = document.getElementById('bl-start');
  if (!startSel || startSel.options.length > 0) return;
  SLOT_TIMES.slice(0, -1).forEach(t => startSel.add(new Option(t, t)));
  updateBlEndOptions();
}

function updateBlEndOptions() {
  const startSel = document.getElementById('bl-start'), endSel = document.getElementById('bl-end');
  if (!startSel || !endSel) return;
  const startIdx = SLOT_TIMES.indexOf(startSel.value);
  endSel.innerHTML = '';
  SLOT_TIMES.slice(startIdx + 1).forEach(t => endSel.add(new Option(t, t)));
}

async function initBlRoomSelect() {
  const sel = document.getElementById('bl-room');
  if (!sel || sel.options.length > 1) return;
  const rooms = await (await fetch('/admin/api/rooms', {headers:H})).json();
  rooms.forEach(r => sel.add(new Option(`${r.floor||''} ${r.name}`, r.id)));
}

async function loadBlockedSlots() {
  initBlTimeSelects();
  initBlRoomSelect();
  const today = new Date().toISOString().slice(0,10);
  const fromEl = document.getElementById('bl-filter-from'), toEl = document.getElementById('bl-filter-to');
  if (!fromEl.value) fromEl.value = today;
  let url = `/admin/api/blocked-slots?from=${fromEl.value}`;
  if (toEl.value) url += `&to=${toEl.value}`;
  const slots = await (await fetch(url, {headers:H})).json();
  const list = document.getElementById('blList');
  if (!slots.length) { list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-60);">æ­¤æœŸé–“æ²’æœ‰å°é–æ™‚æ®µ</div>'; return; }
  const byDate = {};
  slots.forEach(s => { if (!byDate[s.date]) byDate[s.date] = []; byDate[s.date].push(s); });
  list.innerHTML = Object.entries(byDate).map(([date, items]) => `
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--ink-60);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border);">${date}</div>
      ${items.map(s => `
        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid #f5f5f5;">
          <div style="width:120px;font-weight:600;">${s.start_time} â€“ ${s.end_time}</div>
          <div style="flex:1;color:var(--ink-60);font-size:13px;">${s.room_name}${s.reason ? ' Â· ' + s.reason : ''}</div>
          <button class="btn btn-sm btn-danger" onclick="deleteBlockedSlot(${s.id})">åˆªé™¤</button>
        </div>`).join('')}
    </div>`).join('');
}

function clearBlFilter() { document.getElementById('bl-filter-from').value = ''; document.getElementById('bl-filter-to').value = ''; loadBlockedSlots(); }

async function addBlockedSlot() {
  const date = document.getElementById('bl-date').value, start = document.getElementById('bl-start').value;
  const end = document.getElementById('bl-end').value, room = document.getElementById('bl-room').value;
  const reason = document.getElementById('bl-reason').value.trim();
  if (!date) { toast('è«‹é¸æ“‡æ—¥æœŸ', 'error'); return; }
  const status = document.getElementById('blAddStatus');
  status.style.display = 'block'; status.textContent = 'æ–°å¢ä¸­...';
  const res = await fetch('/admin/api/blocked-slots', { method: 'POST', headers: {...H, 'Content-Type':'application/json'}, body: JSON.stringify({ date, start_time: start, end_time: end, room_id: room ? parseInt(room) : null, reason }) });
  if (res.ok) { status.textContent = 'âœ“ å·²æ–°å¢'; toast('å°é–æ™‚æ®µå·²æ–°å¢'); loadBlockedSlots(); setTimeout(() => { status.style.display='none'; }, 2000); }
  else { const d = await res.json(); toast(d.error || 'æ–°å¢å¤±æ•—', 'error'); status.style.display = 'none'; }
}

async function deleteBlockedSlot(id) {
  if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å°é–æ™‚æ®µï¼Ÿ')) return;
  const res = await fetch(`/admin/api/blocked-slots/${id}`, { method:'DELETE', headers:H });
  if (res.ok) { toast('å·²åˆªé™¤'); loadBlockedSlots(); }
  else toast('åˆªé™¤å¤±æ•—', 'error');
}

// â”€â”€ ACCOUNTS â”€â”€
const ALL_PAGES = [
  {id:'dashboard',label:'å„€è¡¨æ¿'},{id:'bookings',label:'é ç´„ç®¡ç†'},
  {id:'rooms',label:'æœƒè­°å®¤ç®¡ç†'},{id:'content',label:'æ–‡å­—å…§å®¹'},
  {id:'photos',label:'ç…§ç‰‡ç®¡ç†'},{id:'formfields',label:'è¡¨å–®æ¬„ä½'},
  {id:'blocked',label:'å°é–æ™‚æ®µ'},{id:'accounts',label:'å¸³è™Ÿç®¡ç†'},
  {id:'logs',label:'ç™»å…¥ç´€éŒ„'}
];

function roleLabel(r) {
  return {superadmin:'è¶…ç´šç®¡ç†å“¡',admin:'ç®¡ç†å“¡',manager:'åº—é•·/ç¶“ç†',staff:'é–€å¸‚äººå“¡'}[r] || r;
}

function roleBadgeClass(r) {
  return {superadmin:'badge-superadmin',admin:'badge-admin',manager:'badge-manager',staff:'badge-staff'}[r] || 'badge-gray';
}

async function loadAccounts() {
  const res = await fetch('/admin/api/accounts', {headers:H});
  const users = await res.json();
  document.getElementById('accountList').innerHTML = `
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>å¸³è™Ÿ</th><th>é¡¯ç¤ºåç¨±</th><th>è§’è‰²</th><th>ç‹€æ…‹</th><th>å»ºç«‹è€…</th><th>å»ºç«‹æ™‚é–“</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
          ${users.map(u => `<tr>
            <td><strong>${u.username}</strong></td>
            <td>${u.display_name||'â€”'}</td>
            <td><span class="badge ${roleBadgeClass(u.role)}">${roleLabel(u.role)}</span></td>
            <td>${u.is_active ? '<span style="color:var(--green);">â— å•Ÿç”¨</span>' : '<span style="color:var(--red);">â— åœç”¨</span>'}</td>
            <td style="color:var(--ink-60);">${u.created_by||'â€”'}</td>
            <td style="color:var(--ink-60);">${u.created_at}</td>
            <td>
              <div style="display:flex;gap:6px;">
                <button class="btn btn-outline btn-sm" onclick="editAccount(${u.id})">ç·¨è¼¯</button>
                ${u.role!=='superadmin' ? `<button class="btn btn-danger btn-sm" onclick="deleteAccount(${u.id})">åˆªé™¤</button>` : ''}
              </div>
            </td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

function onRoleChange() {
  const role = document.getElementById('acc-role').value;
  const grid = document.getElementById('accPermGrid');
  const isSuperadmin = role === 'superadmin';
  grid.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.disabled = isSuperadmin;
    if (isSuperadmin) cb.checked = true;
  });
}

function openAddAccount() {
  document.getElementById('accountModalTitle').textContent = 'æ–°å¢å¸³è™Ÿ';
  document.getElementById('acc-id').value = '';
  document.getElementById('acc-username').value = '';
  document.getElementById('acc-username').disabled = false;
  document.getElementById('acc-display').value = '';
  document.getElementById('acc-pw').value = '';
  document.getElementById('acc-pw').required = true;
  document.getElementById('acc-pw-hint').textContent = 'ï¼ˆæ–°å¢æ™‚å¿…å¡«ï¼‰';
  document.getElementById('acc-role').value = 'staff';
  document.getElementById('acc-active').value = 'true';
  renderPermGrid([]);
  document.getElementById('accountModal').classList.add('show');
}

function togglePwVis() {
  const inp = document.getElementById('acc-pw');
  const eye = document.getElementById('acc-pw-eye');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  eye.textContent = inp.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
}

function editAccount(id) {
  fetch('/admin/api/accounts', {headers:H}).then(r=>r.json()).then(users => {
    const u = users.find(x => x.id === id); if (!u) return;
    document.getElementById('accountModalTitle').textContent = `ç·¨è¼¯å¸³è™Ÿï¼š${u.username}`;
    document.getElementById('acc-id').value = id;
    document.getElementById('acc-username').value = u.username;
    document.getElementById('acc-username').disabled = true;
    document.getElementById('acc-display').value = u.display_name||'';
    document.getElementById('acc-pw').value = '';
    document.getElementById('acc-pw').required = false;
    document.getElementById('acc-pw-hint').textContent = 'ï¼ˆç•™ç©ºè¡¨ç¤ºä¸è®Šæ›´ï¼‰';
    document.getElementById('acc-role').value = u.role;
    document.getElementById('acc-active').value = u.is_active ? 'true' : 'false';
    renderPermGrid(u.permissions||[]);
    document.getElementById('accountModal').classList.add('show');
  });
}

function renderPermGrid(selected) {
  const role = document.getElementById('acc-role').value;
  const isSuperadmin = role === 'superadmin';
  document.getElementById('accPermGrid').innerHTML = ALL_PAGES.map(p =>
    `<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;padding:4px;">
      <input type="checkbox" value="${p.id}" ${selected.includes(p.id)||isSuperadmin?'checked':''} ${isSuperadmin?'disabled':''}> ${p.label}
    </label>`).join('');
}

function getSelectedPerms() {
  return [...document.querySelectorAll('#accPermGrid input:checked')].map(el => el.value);
}

function closeAccountModal() { document.getElementById('accountModal').classList.remove('show'); }

async function saveAccount() {
  const id      = document.getElementById('acc-id').value;
  const uname   = document.getElementById('acc-username').value.trim();
  const display = document.getElementById('acc-display').value.trim();
  const pw      = document.getElementById('acc-pw').value;
  const role    = document.getElementById('acc-role').value;
  const active  = document.getElementById('acc-active').value === 'true';
  const perms   = getSelectedPerms();
  if (!uname) { toast('è«‹å¡«å¯«å¸³è™Ÿ', 'error'); return; }
  if (!id && !pw) { toast('è«‹è¨­å®šå¯†ç¢¼', 'error'); return; }
  const body = {username: uname, display_name: display, role, is_active: active, permissions: perms};
  if (pw) body.password = pw;
  const url = id ? `/admin/api/accounts/${id}` : '/admin/api/accounts';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(url, {method, headers: {...H, 'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const data = await res.json();
  if (res.ok) { toast(id ? 'å¸³è™Ÿå·²æ›´æ–°' : 'å¸³è™Ÿå»ºç«‹æˆåŠŸ'); closeAccountModal(); loadAccounts(); }
  else toast(data.error || 'å„²å­˜å¤±æ•—', 'error');
}

async function deleteAccount(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸³è™Ÿï¼Ÿ')) return;
  const res = await fetch(`/admin/api/accounts/${id}`, {method:'DELETE', headers:H});
  const data = await res.json();
  if (res.ok) { toast('å¸³è™Ÿå·²åˆªé™¤'); loadAccounts(); }
  else toast(data.error || 'åˆªé™¤å¤±æ•—', 'error');
}

// â”€â”€ LOGIN LOGS â”€â”€
function clearLogFilters() {
  const u = document.getElementById('log-fil-user');
  const r = document.getElementById('log-fil-result');
  if (u) u.value = '';
  if (r) r.value = '';
  loadLoginLogs();
}

function parseUA(ua) {
  if (!ua) return 'â€”';
  // è§£æç€è¦½å™¨åç¨±
  let browser = ua;
  if (/Edg\//i.test(ua))       browser = 'Edge ' + (ua.match(/Edg\/([\d.]+)/)?.[1]||'');
  else if (/OPR\//i.test(ua))  browser = 'Opera ' + (ua.match(/OPR\/([\d.]+)/)?.[1]||'');
  else if (/Chrome\//i.test(ua)) browser = 'Chrome ' + (ua.match(/Chrome\/([\d.]+)/)?.[1]||'');
  else if (/Firefox\//i.test(ua)) browser = 'Firefox ' + (ua.match(/Firefox\/([\d.]+)/)?.[1]||'');
  else if (/Safari\//i.test(ua)) browser = 'Safari ' + (ua.match(/Version\/([\d.]+)/)?.[1]||'');
  // OS
  let os = '';
  if (/Windows NT 10/i.test(ua))   os = 'Windows 10/11';
  else if (/Windows NT 6.1/i.test(ua)) os = 'Windows 7';
  else if (/Mac OS X/i.test(ua))   os = 'macOS ' + (ua.match(/Mac OS X ([\d_]+)/)?.[1]?.replace(/_/g,'.')||'');
  else if (/iPhone/i.test(ua))     os = 'iPhone';
  else if (/iPad/i.test(ua))       os = 'iPad';
  else if (/Android/i.test(ua))    os = 'Android ' + (ua.match(/Android ([\d.]+)/)?.[1]||'');
  else if (/Linux/i.test(ua))      os = 'Linux';
  return os ? `${browser} / ${os}` : browser;
}

async function loadLoginLogs() {
  const uname   = document.getElementById('log-fil-user')?.value?.trim() || '';
  const success = document.getElementById('log-fil-result')?.value || '';
  let url = `/admin/api/login-logs?per=200`;
  if (uname)   url += `&username=${encodeURIComponent(uname)}`;
  if (success) url += `&success=${success}`;
  const res = await fetch(url, {headers:H});
  const data = await res.json();
  const logs = data.logs || [];
  const list = document.getElementById('loginLogList');
  // ä¸Šæ¬¡ç™»å…¥è³‡è¨Šï¼ˆä¸å—ç¯©é¸å½±éŸ¿ï¼Œå–å…¨éƒ¨æœ€è¿‘å…©ç­†æˆåŠŸï¼‰
  const lastInfo = document.getElementById('lastLoginInfo');
  if (lastInfo && !uname && !success) {
    const succ = logs.filter(l => l.success);
    if (succ.length >= 2) {
      const prev = succ[1];
      lastInfo.innerHTML = `ä¸Šæ¬¡ç™»å…¥ï¼š${prev.login_at}ã€€IPï¼š${prev.ip_address||'â€”'}`;
    } else if (succ.length === 1) {
      lastInfo.textContent = 'é€™æ˜¯é¦–æ¬¡ç™»å…¥';
    }
  }
  if (!logs.length) { list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-60);">æ‰¾ä¸åˆ°ç¬¦åˆçš„ç´€éŒ„</div>'; return; }
  list.innerHTML = `
    <div style="font-size:13px;color:var(--ink-60);margin-bottom:12px;">å…± ${data.total} ç­†ï¼ˆé¡¯ç¤º ${logs.length} ç­†ï¼‰</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>ç™»å…¥æ™‚é–“</th><th>å¸³è™Ÿ</th><th>çµæœ</th><th>IP ä½å€</th><th>åœ°å€</th><th>ç€è¦½å™¨ / è£ç½®</th>
        </tr></thead>
        <tbody>
          ${logs.map((l, i) => `<tr style="${i===0&&l.success&&!uname&&!success?'background:#f0faf5;':''}">
            <td style="white-space:nowrap;font-weight:${i===0&&!uname&&!success?'600':'400'};">${l.login_at}${i===0&&l.success&&!uname&&!success?` <span style="background:var(--gold);color:#fff;font-size:10px;padding:1px 6px;border-radius:10px;vertical-align:middle;margin-left:4px;">æœ¬æ¬¡</span>`:''}</td>
            <td><strong>${l.username}</strong></td>
            <td>${l.success ? '<span style="color:var(--green);font-weight:600;">âœ“ æˆåŠŸ</span>' : '<span style="color:var(--red);font-weight:600;">âœ— å¤±æ•—</span>'}</td>
            <td style="font-family:monospace;font-size:12px;white-space:nowrap;">${l.ip_address||'â€”'}</td>
            <td style="font-size:13px;white-space:nowrap;">${[l.country,l.city].filter(Boolean).join(' ')||'â€”'}</td>
            <td style="font-size:12px;color:var(--ink-60);white-space:normal;word-break:break-word;min-width:220px;">${parseUA(l.user_agent)}<br><span style="font-size:11px;opacity:.6;" title="${(l.user_agent||'').replace(/"/g,'&quot;')}">${l.user_agent||''}</span></td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

// â”€â”€ CURRENT USER & PERMISSION CONTROL â”€â”€
let _myPerms = [];  // å…¨åŸŸå„²å­˜ç•¶å‰ç”¨æˆ¶æ¬Šé™

async function loadCurrentUser() {
  try {
    const res = await fetch('/admin/api/me', {headers:H});
    if (res.ok) {
      const u = await res.json();
      _myPerms = u.permissions || [];
      const el = document.getElementById('currentUserInfo');
      if (el) el.innerHTML = `<span style="color:rgba(255,255,255,0.8);">&#128100; ${u.display_name||u.username}</span> <span style="color:var(--gold);font-size:11px;">${roleLabel(u.role)}</span>`;
      // æ ¹æ“šæ¬Šé™æ§åˆ¶å´é‚Šæ¬„é¡¯ç¤º
      applyPermissions(_myPerms);
    }
    // æœ¬æ¬¡ & ä¸Šæ¬¡ç™»å…¥æ™‚é–“
    const lr = await fetch('/admin/api/login-logs?per=2', {headers:H});
    if (lr.ok) {
      const ld = await lr.json();
      const logs = (ld.logs||[]).filter(l => l.success);
      const el = document.getElementById('currentUserInfo');
      if (el && logs.length > 0) {
        el.innerHTML += `<br><span style="font-size:11px;color:rgba(255,255,255,0.35);">æœ¬æ¬¡ï¼š${logs[0].login_at}</span>`;
        if (logs.length > 1) el.innerHTML += `<br><span style="font-size:11px;color:rgba(255,255,255,0.25);">ä¸Šæ¬¡ï¼š${logs[1].login_at}</span>`;
      }
    }
  } catch(e) {}
}

function applyPermissions(perms) {
  // page id â†’ å°èˆª onclick å­—ä¸²å°æ‡‰
  const PAGE_NAV_MAP = {
    'dashboard':  "showPage('dashboard'",
    'bookings':   "showPage('bookings'",
    'rooms':      "showPage('rooms'",
    'content':    "showPage('content'",
    'photos':     "showPage('photos'",
    'formfields': "showPage('formfields'",
    'blocked':    "showPage('blocked'",
    'accounts':   "showPage('accounts'",
    'logs':       "showPage('logs'",
  };
  document.querySelectorAll('.nav-item').forEach(item => {
    const oc = item.getAttribute('onclick') || '';
    for (const [pageId, pattern] of Object.entries(PAGE_NAV_MAP)) {
      if (oc.includes(pattern)) {
        item.style.display = perms.includes(pageId) ? '' : 'none';
        break;
      }
    }
  });
  // å¦‚æœç•¶å‰é é¢æ²’æœ‰æ¬Šé™ï¼Œè·³è½‰åˆ°ç¬¬ä¸€å€‹æœ‰æ¬Šé™çš„é é¢
  const currentPage = document.querySelector('.page.active')?.id?.replace('page-','');
  if (currentPage && !perms.includes(currentPage)) {
    const firstAllowed = perms[0];
    if (firstAllowed) {
      const navEl = document.querySelector(`.nav-item[onclick*="'${firstAllowed}'"]`);
      showPage(firstAllowed, navEl);
    }
  }
}

// â”€â”€ HELPERS â”€â”€
function fmtSegments(b) {
  if (b.segments) {
    try {
      const segs = typeof b.segments === 'string' ? JSON.parse(b.segments) : b.segments;
      if (segs && segs.length > 1) return segs.map(s => `${s.start}â€“${s.end}`).join('<br>');
      if (segs && segs.length === 1) return `${segs[0].start} â€“ ${segs[0].end}`;
    } catch(e) {}
  }
  return `${b.start_time} â€“ ${b.end_time}`;
}

function badgeHtml(status) {
  const map = {confirmed: ['badge-green','å·²ç¢ºèª'], cancelled: ['badge-red','å·²å–æ¶ˆ'], completed: ['badge-gold','å·²å®Œæˆ']};
  const [cls, txt] = map[status] || ['badge-gray', status];
  return `<span class="badge ${cls}">${txt}</span>`;
}

// â”€â”€ INIT â”€â”€
initFloorDate();
loadDashboard();
loadFloorStatus();
</script>
</body>
</html>