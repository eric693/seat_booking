<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>管理後台 — 會議室預約系統</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0F0F0F;
  --ink-60: rgba(15,15,15,0.6);
  --ink-20: rgba(15,15,15,0.1);
  --paper: #F5F2ED;
  --white: #FFFFFF;
  --gold: #B8965A;
  --gold-light: #F2E8D5;
  --teal: #2A6B6B;
  --teal-light: #E8F2F2;
  --red: #C44B3A;
  --red-light: #FFF0EE;
  --green: #3A7C55;
  --green-light: #EEF7F2;
  --border: rgba(15,15,15,0.1);
  --sidebar: 240px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}

body { font-family:'DM Sans',sans-serif; background:var(--paper); color:var(--ink); display:flex; min-height:100vh; }

/* ── SIDEBAR ── */
.sidebar {
  width: var(--sidebar);
  background: var(--ink);
  color: white;
  position: fixed;
  top:0; left:0; bottom:0;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.sidebar-logo {
  padding: 20px 20px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  align-items: center;
  gap: 10px;
}

.sidebar-logo-icon {
  width: 32px; height: 32px;
  background: var(--gold);
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.sidebar-logo-text {
  font-family: 'DM Serif Display', serif;
  font-size: 15px;
  line-height: 1.2;
}

.sidebar-logo-text small {
  display: block;
  font-family: 'DM Sans', sans-serif;
  font-size: 10px;
  color: rgba(255,255,255,0.4);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

nav { padding: 12px 0; flex: 1; }

.nav-section {
  padding: 8px 16px 4px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: rgba(255,255,255,0.3);
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 14px;
  color: rgba(255,255,255,0.6);
  transition: all 0.2s;
  border-left: 3px solid transparent;
}

.nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
.nav-item.active { color: white; background: rgba(184,150,90,0.15); border-left-color: var(--gold); }
.nav-icon { font-size: 16px; width: 20px; text-align: center; }

.sidebar-bottom {
  padding: 16px 20px;
  border-top: 1px solid rgba(255,255,255,0.08);
}

.logout-btn {
  width: 100%;
  padding: 9px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.6);
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-family: inherit;
  transition: all 0.2s;
}
.logout-btn:hover { background: rgba(196,75,58,0.2); color: #ff8a80; border-color: rgba(196,75,58,0.3); }

/* ── MAIN ── */
.main {
  margin-left: var(--sidebar);
  flex: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.topbar {
  background: white;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 50;
}

.topbar-title {
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.preview-btn {
  padding: 8px 16px;
  background: var(--teal);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  transition: all 0.2s;
}
.preview-btn:hover { background: #1e5050; }

.content { padding: 32px; flex: 1; }

.page { display: none; }
.page.active { display: block; }

/* ── STAT CARDS ── */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.stat-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 22px 24px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--gold);
}

.stat-lbl {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-60);
  font-weight: 600;
  margin-bottom: 8px;
}

.stat-val {
  font-family: 'DM Serif Display', serif;
  font-size: 36px;
  color: var(--ink);
  line-height: 1;
  margin-bottom: 4px;
}

.stat-sub { font-size: 12px; color: var(--ink-60); }

/* ── CARD ── */
.card {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 24px;
}

.card-head {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
}

.card-body { padding: 24px; }

/* ── BUTTONS ── */
.btn {
  padding: 9px 18px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  font-family: inherit;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary { background: var(--teal); color: white; }
.btn-primary:hover { background: #1e5050; }
.btn-gold { background: var(--gold); color: white; }
.btn-gold:hover { background: #9a7a48; }
.btn-danger { background: var(--red); color: white; }
.btn-danger:hover { background: #a33d2e; }
.btn-outline { background: none; border: 1.5px solid var(--border); color: var(--ink); }
.btn-outline:hover { border-color: var(--ink); }
.btn-sm { padding: 6px 12px; font-size: 12px; }

/* ── TABLE ── */
.tbl-wrap { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; }
th {
  background: var(--paper);
  padding: 10px 14px;
  text-align: left;
  font-size: 11px;
  font-weight: 600;
  color: var(--ink-60);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  border-bottom: 1px solid var(--border);
}
td { padding: 13px 14px; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
tr:hover td { background: #fafafa; }

/* ── BADGE ── */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 12px;
  font-weight: 500;
}
.badge-green { background: var(--green-light); color: var(--green); }
.badge-red { background: var(--red-light); color: var(--red); }
.badge-gold { background: var(--gold-light); color: #8a6e3e; }
.badge-gray { background: #f0f0f0; color: #666; }

/* ── FILTERS ── */
.filters {
  display: flex;
  gap: 12px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 6px;
}

.filter-lbl { font-size: 13px; color: var(--ink-60); }

.filter-input, .filter-select {
  padding: 7px 12px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  font-size: 13px;
  font-family: inherit;
  color: var(--ink);
  background: white;
}
.filter-input:focus, .filter-select:focus { outline: none; border-color: var(--teal); }

/* ── MODAL ── */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.modal.show { display: flex; }

.modal-box {
  background: white;
  border-radius: 10px;
  padding: 32px;
  max-width: 600px;
  width: 92%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  margin-bottom: 24px;
}

.modal-footer {
  margin-top: 24px;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* ── FORM ── */
.fg { margin-bottom: 18px; }
.fg label {
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
}
.fg label span { font-weight: 400; color: var(--ink-60); font-size: 12px; }
.finput, .fselect, .ftarea {
  width: 100%;
  padding: 10px 13px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  font-size: 14px;
  font-family: inherit;
  color: var(--ink);
  background: white;
  transition: border-color 0.2s;
}
.finput:focus, .fselect:focus, .ftarea:focus { outline: none; border-color: var(--teal); }
.ftarea { resize: vertical; min-height: 90px; }
.fselect { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; cursor: pointer; }
.fgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* ── PHOTO UPLOAD ── */
.photo-upload-area {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 28px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--paper);
  position: relative;
}
.photo-upload-area:hover { border-color: var(--teal); background: var(--teal-light); }
.photo-upload-area.dragover { border-color: var(--gold); background: var(--gold-light); }
.photo-upload-icon { font-size: 32px; margin-bottom: 10px; }
.photo-upload-text { font-size: 14px; color: var(--ink-60); }
.photo-upload-text strong { color: var(--teal); }
#photoFileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

.photo-preview {
  position: relative;
  display: inline-block;
  margin-top: 12px;
}
.photo-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 6px;
  object-fit: cover;
  border: 2px solid var(--border);
}
.photo-preview-remove {
  position: absolute;
  top: -8px; right: -8px;
  width: 24px; height: 24px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
}

.current-photo-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 6px;
  margin-bottom: 12px;
}
.current-photo-row img {
  width: 60px; height: 45px;
  object-fit: cover;
  border-radius: 4px;
}
.current-photo-row span { font-size: 13px; color: var(--ink-60); }

/* ── AMENITIES ── */
.amenity-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}
.amenity-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.amenity-tag {
  background: var(--gold-light);
  color: #8a6e3e;
  border: 1px solid rgba(184,150,90,0.3);
  padding: 4px 10px;
  border-radius: 100px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.amenity-remove { cursor: pointer; color: var(--gold); font-weight: bold; font-size: 14px; line-height: 1; }
.amenity-remove:hover { color: var(--red); }

/* ── SITE CONTENT PAGE ── */
.content-sections {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.content-section {
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

.cs-head {
  background: var(--paper);
  padding: 14px 18px;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--ink-60);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}

.cs-body { padding: 16px; }

.cs-field { margin-bottom: 14px; }
.cs-field:last-child { margin-bottom: 0; }
.cs-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--ink-60);
  margin-bottom: 5px;
  display: block;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

/* ── ROOM CARDS ADMIN ── */
.floor-section{margin-bottom:22px;}
.floor-label{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-60);margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.room-row{display:grid;grid-template-columns:150px 1fr;align-items:center;gap:10px;margin-bottom:7px;min-width:640px;}
.room-row-name{font-size:13px;font-weight:600;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.room-row-cap{font-size:11px;color:var(--ink-60);}
.slots-wrap{display:flex;gap:2px;}
.slot-cell{flex:1;height:30px;border-radius:3px;position:relative;cursor:default;min-width:16px;transition:transform .1s;}
.slot-cell:hover{transform:scaleY(1.2);z-index:2;}
.slot-cell.free{background:#3A7C55;}
.slot-cell.booked{background:#C44B3A;}
.slot-cell.now-free{background:#B8965A;}
.slot-cell.now-booked{background:#8B3022;}
.slot-cell.past{background:var(--ink-20);}
.slot-cell .stip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--ink);color:#fff;font-size:11px;padding:4px 8px;border-radius:4px;white-space:nowrap;z-index:100;pointer-events:none;}
.slot-cell:hover .stip{display:block;}
.time-axis{display:flex;gap:2px;padding-left:160px;margin-bottom:4px;min-width:640px;}
.time-tick{flex:1;font-size:10px;color:var(--ink-60);min-width:16px;}
.room-admin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.room-admin-card {
  background: white;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  transition: box-shadow 0.2s;
}
.room-admin-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
.room-admin-card.inactive { opacity: 0.5; }

.rac-photo {
  width: 100%; height: 140px;
  object-fit: cover;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  color: rgba(255,255,255,0.2);
  position: relative;
}

.rac-photo img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.rac-photo-placeholder {
  width: 100%; height: 140px;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  color: rgba(255,255,255,0.2);
}

.rac-status {
  position: absolute;
  top: 8px; right: 8px;
  padding: 3px 8px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
}

.rac-body { padding: 16px; }
.rac-type { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--gold); margin-bottom: 4px; }
.rac-name { font-family: 'DM Serif Display', serif; font-size: 18px; margin-bottom: 6px; }
.rac-desc {
  font-size: 12px;
  color: var(--ink-60);
  line-height: 1.5;
  margin-top: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.rac-meta { font-size: 13px; color: var(--ink-60); margin-bottom: 12px; }
.rac-actions { display: flex; gap: 8px; border-top: 1px solid var(--border); padding-top: 14px; }

/* upload progress */
.upload-progress {
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 8px;
  display: none;
}
.upload-progress-bar {
  height: 100%;
  background: var(--teal);
  border-radius: 2px;
  transition: width 0.3s;
}

/* ── TOAST ── */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--ink);
  color: white;
  padding: 14px 20px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 9999;
  transform: translateY(80px);
  opacity: 0;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 360px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--teal); }
.toast.error { background: var(--red); }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon" id="sidebarLogoIcon">MR</div>
    <div class="sidebar-logo-text">
      會議室系統
      <small>Admin Panel</small>
    </div>
  </div>
  <nav>
    <div class="nav-section">總覽</div>
    <div class="nav-item active" onclick="showPage('dashboard',this)">
      <span class="nav-icon">■</span> 儀表板
    </div>
    <div class="nav-section">管理</div>
    <div class="nav-item" onclick="showPage('bookings',this)">
      <span class="nav-icon">&#9700;</span> 預約管理
    </div>
    <div class="nav-item" onclick="showPage('rooms',this)">
      <span class="nav-icon">&#9632;</span> 會議室管理
    </div>
    <div class="nav-section">前台設定</div>
    <div class="nav-item" onclick="showPage('content',this)">
      <span class="nav-icon">&#9998;</span> 文字內容編輯
    </div>
    <div class="nav-item" onclick="showPage('photos',this)">
      <span class="nav-icon">&#9728;</span> 照片管理
    </div>
    <div class="nav-item" onclick="showPage('formfields',this)">
      <span class="nav-icon">&#9783;</span> 表單欄位
    </div>
    <div class="nav-item" onclick="showPage('blocked',this)">
      <span class="nav-icon">&#128683;</span> 封鎖時段
    </div>
  </nav>
  <div class="sidebar-bottom">
    <button class="logout-btn" onclick="logout()">登出後台</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">儀表板</div>
    <div class="topbar-right">
      <button class="preview-btn" onclick="window.open('/', '_blank')">查看前台</button>
    </div>
  </div>

  <div class="content">

    <!-- ── DASHBOARD ── -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-lbl">有效預約</div>
          <div class="stat-val" id="st-total">—</div>
          <div class="stat-sub">累計確認</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">今日預約</div>
          <div class="stat-val" id="st-today">—</div>
          <div class="stat-sub">今天</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">可用會議室</div>
          <div class="stat-val" id="st-rooms">—</div>
          <div class="stat-sub">已啟用</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">累計營收</div>
          <div class="stat-val" id="st-revenue">—</div>
          <div class="stat-sub">NT$</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">已取消</div>
          <div class="stat-val" id="st-cancelled">—</div>
          <div class="stat-sub">取消數</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">已完成</div>
          <div class="stat-val" id="st-completed">—</div>
          <div class="stat-sub">完成數</div>
        </div>
      </div>

      <!-- ── 樓層時段看板 ── -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div class="card-title">樓層時段看板</div>
          <div style="display:flex;align-items:center;gap:12px;">
            <input type="date" id="floor-date" class="filter-input"
              style="font-size:13px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--white);"
              onchange="loadFloorStatus()">
            <button class="btn btn-outline btn-sm" onclick="loadFloorStatus()">重新整理</button>
          </div>
        </div>
        <div class="card-body" style="padding:16px 20px;">
          <!-- 圖例 -->
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#3A7C55;"></div> 空閒
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#C44B3A;"></div> 已預約
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:#B8965A;"></div> 進行中
            </div>
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-60);">
              <div style="width:14px;height:14px;border-radius:3px;background:var(--ink-20);"></div> 非服務時段
            </div>
          </div>
          <div id="floor-board" style="overflow-x:auto;">
            <div style="text-align:center;padding:30px;color:var(--ink-60);">載入中...</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">最新預約</div>
          <button class="btn btn-outline btn-sm" onclick="showPage('bookings', document.querySelector('[onclick*=bookings]'))">查看全部</button>
        </div>
        <div class="card-body">
          <!-- 篩選列 -->
          <div class="filters" style="margin-bottom:16px;">
            <div class="filter-group">
              <span class="filter-lbl">日期</span>
              <input type="date" class="filter-input" id="dash-fil-date" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
            </div>
            <div class="filter-group">
              <span class="filter-lbl">狀態</span>
              <select class="filter-select" id="dash-fil-status" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
                <option value="">全部</option>
                <option value="confirmed">已確認</option>
                <option value="cancelled">已取消</option>
                <option value="completed">已完成</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="filter-lbl">會議室</span>
              <select class="filter-select" id="dash-fil-room" onchange="loadDashboardBookings()" style="font-size:13px;padding:6px 10px;">
                <option value="">全部</option>
              </select>
            </div>
            <button class="btn btn-outline btn-sm" onclick="clearDashFilters()">清除篩選</button>
          </div>
          <div class="tbl-wrap">
            <table>
              <thead><tr>
                <th>預約編號</th><th>聯絡人</th><th>會議室</th><th>日期</th><th>時段</th><th>狀態</th>
              </tr></thead>
              <tbody id="dash-bookings"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ── BOOKINGS ── -->
    <div class="page" id="page-bookings">
      <div class="card">
        <div class="card-head">
          <div class="card-title">預約管理</div>
        </div>
        <div class="card-body">
          <div class="filters">
            <div class="filter-group">
              <span class="filter-lbl">日期</span>
              <input type="date" class="filter-input" id="fil-date" onchange="loadBookings()">
            </div>
            <div class="filter-group">
              <span class="filter-lbl">狀態</span>
              <select class="filter-select" id="fil-status" onchange="loadBookings()">
                <option value="">全部</option>
                <option value="confirmed">已確認</option>
                <option value="cancelled">已取消</option>
                <option value="completed">已完成</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="filter-lbl">會議室</span>
              <select class="filter-select" id="fil-room" onchange="loadBookings()">
                <option value="">全部</option>
              </select>
            </div>
          </div>
          <div class="tbl-wrap">
            <table>
              <thead><tr>
                <th>預約編號</th><th>聯絡人</th><th>部門</th><th>會議室</th>
                <th>日期</th><th>時段</th><th>時長</th><th>人數</th><th>金額</th><th>狀態</th><th>操作</th>
              </tr></thead>
              <tbody id="bookings-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ── ROOMS ── -->
    <div class="page" id="page-rooms">
      <div class="card">
        <div class="card-head">
          <div class="card-title">會議室管理</div>
          <button class="btn btn-primary" onclick="openRoomModal()">＋ 新增會議室</button>
        </div>
        <div class="card-body">
          <div class="room-admin-grid" id="roomAdminGrid">
            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--ink-60);">載入中...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── SITE CONTENT ── -->
    <div class="page" id="page-content">
      <div class="card">
        <div class="card-head">
          <div class="card-title">前台文字內容編輯</div>
          <button class="btn btn-primary" onclick="saveContent()">儲存所有變更</button>
        </div>
        <div class="card-body">
          <div class="content-sections">

            <!-- ── 主頁 Hero 區塊 ── -->
            <div class="content-section" style="grid-column:1/-1;">
              <div class="cs-head">主頁 Hero 區塊</div>
              <div class="cs-body">
                <div class="fgrid">
                  <div class="cs-field">
                    <label class="cs-label">網站標題（瀏覽器分頁 / Logo）</label>
                    <input class="finput" type="text" id="c-site_title" placeholder="會議室預約系統">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">標語小標籤（Hero Badge）</label>
                    <input class="finput" type="text" id="c-hero_badge" placeholder="專業會議空間">
                  </div>
                  <div class="cs-field" style="grid-column:1/-1;">
                    <label class="cs-label">主標題（支援 &lt;em&gt; 強調色，例：企業&lt;em&gt;會議室&lt;/em&gt;&lt;br&gt;即時預約）</label>
                    <input class="finput" type="text" id="c-site_subtitle" placeholder="企業&lt;em&gt;會議室&lt;/em&gt;&lt;br&gt;即時預約">
                  </div>
                  <div class="cs-field" style="grid-column:1/-1;">
                    <label class="cs-label">Hero 副標說明文字</label>
                    <textarea class="ftarea" id="c-site_description" placeholder="提供多種類型會議室，彈性時段預約，滿足各種商務需求。" rows="2"></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- ── 三大步驟標題 ── -->
            <div class="content-section">
              <div class="cs-head">預約步驟標題</div>
              <div class="cs-body">
                <div class="cs-field">
                  <label class="cs-label">Step 1 標題</label>
                  <input class="finput" type="text" id="c-step1_title" placeholder="選擇會議室">
                </div>
                <div class="cs-field">
                  <label class="cs-label">Step 2 標題</label>
                  <input class="finput" type="text" id="c-step2_title" placeholder="選擇日期與時段">
                </div>
                <div class="cs-field">
                  <label class="cs-label">Step 3 標題</label>
                  <input class="finput" type="text" id="c-step3_title" placeholder="填寫聯絡資料">
                </div>
              </div>
            </div>

            <!-- ── 聯絡與服務 ── -->
            <div class="content-section">
              <div class="cs-head">聯絡與服務資訊</div>
              <div class="cs-body">
                <div class="cs-field">
                  <label class="cs-label">服務時間</label>
                  <input class="finput" type="text" id="c-service_hours" placeholder="週一至週五 08:00 – 22:00">
                </div>
                <div class="cs-field">
                  <label class="cs-label">聯絡電話（顯示於導覽列）</label>
                  <input class="finput" type="text" id="c-contact_phone" placeholder="02-1234-5678">
                </div>
                <div class="cs-field">
                  <label class="cs-label">聯絡 Email</label>
                  <input class="finput" type="email" id="c-contact_email" placeholder="booking@example.com">
                </div>
                <div class="cs-field">
                  <label class="cs-label">頁尾版權文字</label>
                  <input class="finput" type="text" id="c-footer_text" placeholder="© 2026 會議室預約系統">
                </div>
              </div>
            </div>

            <!-- ── 預約須知 ── -->
            <div class="content-section" style="grid-column:1/-1;">
              <div class="cs-head">預約須知（顯示於確認側邊欄，最多 5 條）</div>
              <div class="cs-body">
                <div class="fgrid">
                  <div class="cs-field">
                    <label class="cs-label">須知 1</label>
                    <input class="finput" type="text" id="c-notice_1" placeholder="請提前 15 分鐘辦理入場手續">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">須知 2</label>
                    <input class="finput" type="text" id="c-notice_2" placeholder="取消或更改請提前 2 小時通知">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">須知 3</label>
                    <input class="finput" type="text" id="c-notice_3" placeholder="禁止攜帶食物進入精緻會議室">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">須知 4</label>
                    <input class="finput" type="text" id="c-notice_4" placeholder="使用後請恢復設備原始設定">
                  </div>
                  <div class="cs-field">
                    <label class="cs-label">須知 5</label>
                    <input class="finput" type="text" id="c-notice_5" placeholder="逾時使用將依時薪計費">
                  </div>
                </div>
              </div>
            </div>

          </div>
          <div style="margin-top:20px;text-align:right;">
            <button class="btn btn-primary" onclick="saveContent()" style="padding:12px 28px;font-size:15px;">儲存所有變更</button>
          </div>

          <!-- 通知設定說明 -->
          <div style="margin-top:28px;padding:20px;background:var(--paper);border-radius:8px;border:1px solid var(--border);">
            <div style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--ink);margin-bottom:12px;">通知服務設定（Render 環境變數）</div>
            <div style="font-size:13px;color:var(--ink-60);line-height:1.9;">
              以下設定需在 <strong>Render → Environment</strong> 頁面填入：<br>
              <strong style="color:var(--ink);">Email（二選一）</strong><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">SENDGRID_API_KEY</code> — SendGrid API Key（推薦，免費方案每天 100 封）<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">MAIL_FROM</code> — 寄件人地址（需與 SendGrid 驗證的寄件人一致）<br>
              <span style="color:#888;font-size:12px;">— 或 —</span><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">GMAIL_USER</code> — Gmail 帳號（備用方案）<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">GMAIL_APP_PASS</code> — Gmail 應用程式密碼（需先開啟 2FA）<br>
              <br><strong style="color:var(--ink);">SMS 簡訊</strong><br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_SID</code> — Twilio Account SID（免費試用可用）<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_TOKEN</code> — Twilio Auth Token<br>
              <code style="background:#e8e8e8;padding:2px 6px;border-radius:3px;font-size:12px;">TWILIO_FROM</code> — Twilio 發送號碼，例：+15005550006<br>
              <span style="color:var(--green);font-size:12px;">未填入則略過該通知，不影響預約功能。</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── PHOTOS ── -->
    <div class="page" id="page-photos">

      <!-- Logo 上傳 -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div class="card-title">系統 Logo</div>
          <div style="font-size:13px;color:var(--ink-60);">更換後台與前台左上角 Logo</div>
        </div>
        <div class="card-body">
          <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
            <div id="logoPreviewWrap" style="width:80px;height:80px;border-radius:12px;background:var(--sidebar-bg);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:var(--gold);flex-shrink:0;overflow:hidden;">
              <span id="logoPreviewText">MR</span>
            </div>
            <div style="flex:1;min-width:200px;">
              <label class="btn btn-outline" style="cursor:pointer;display:inline-block;">
                <input type="file" accept="image/*" style="display:none;" onchange="uploadLogo(event)">
                &#128247; 選擇 Logo 圖片
              </label>
              <div style="font-size:12px;color:var(--ink-60);margin-top:8px;">支援 JPG、PNG、WEBP，建議尺寸 80×80px 以上，最大 16MB</div>
            </div>
            <div id="logoUploadStatus" style="font-size:13px;color:var(--teal);display:none;">上傳中...</div>
          </div>
        </div>
      </div>

      <!-- 會議室照片管理 -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">會議室照片管理</div>
          <div style="font-size:13px;color:var(--ink-60);">每間最多 5 張，可設定主封面</div>
        </div>
        <div class="card-body">
          <div id="photoRoomList">
            <div style="text-align:center;padding:40px;color:var(--ink-60);">載入中...</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

    <div class="page" id="page-formfields">
      <div class="card">
        <div class="card-head">
          <div class="card-title">表單欄位管理</div>
          <button class="btn btn-primary btn-sm" onclick="addFormField()">+ 新增欄位</button>
        </div>
        <div class="card-body">
          <div style="font-size:13px;color:var(--ink-60);margin-bottom:16px;">
            拖曳可調整順序・系統欄位（姓名/手機/Email）無法刪除・必填欄位未填無法送出
          </div>
          <div id="ffList" style="display:flex;flex-direction:column;gap:10px;"></div>
          <div style="margin-top:20px;display:flex;gap:10px;">
            <button class="btn btn-primary" onclick="saveFormFields()">儲存變更</button>
            <button class="btn btn-outline" onclick="resetFormFields()">還原預設</button>
          </div>
        </div>
      </div>
    </div>

    <div class="page" id="page-blocked">
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div class="card-title">新增封鎖時段</div>
        </div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;align-items:end;flex-wrap:wrap;">
            <div>
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">日期</label>
              <input type="date" class="finput" id="bl-date" style="padding:8px;">
            </div>
            <div>
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">開始時間</label>
              <select class="fselect" id="bl-start" style="padding:8px;" onchange="updateBlEndOptions()"></select>
            </div>
            <div>
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">結束時間</label>
              <select class="fselect" id="bl-end" style="padding:8px;"></select>
            </div>
            <div>
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">會議室</label>
              <select class="fselect" id="bl-room" style="padding:8px;">
                <option value="">全館（所有會議室）</option>
              </select>
            </div>
            <div style="grid-column:1/-1;">
              <label style="font-size:12px;color:var(--ink-60);display:block;margin-bottom:4px;">原因（選填）</label>
              <input type="text" class="finput" id="bl-reason" placeholder="例：清潔維護、場地整修..." style="padding:8px;">
            </div>
          </div>
          <div style="margin-top:14px;display:flex;gap:10px;align-items:center;">
            <button class="btn btn-primary" onclick="addBlockedSlot()">+ 新增封鎖</button>
            <span id="blAddStatus" style="font-size:13px;color:var(--teal);display:none;"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-title">封鎖時段列表</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <input type="date" class="finput" id="bl-filter-from" style="padding:6px 8px;font-size:13px;" onchange="loadBlockedSlots()">
            <span style="color:var(--ink-60);">至</span>
            <input type="date" class="finput" id="bl-filter-to" style="padding:6px 8px;font-size:13px;" onchange="loadBlockedSlots()">
            <button class="btn btn-outline btn-sm" onclick="clearBlFilter()">清除</button>
          </div>
        </div>
        <div class="card-body">
          <div id="blList"><div style="text-align:center;padding:40px;color:var(--ink-60);">載入中...</div></div>
        </div>
      </div>
    </div>

<!-- Room Modal -->
<div class="modal" id="roomModal">
  <div class="modal-box">
    <div class="modal-title" id="roomModalTitle">新增會議室</div>
    <input type="hidden" id="rm-id">

    <div class="fgrid">
      <div class="fg">
        <label>會議室名稱</label>
        <input class="finput" type="text" id="rm-name" placeholder="例：精緻洽談室 A">
      </div>
      <div class="fg">
        <label>類型</label>
        <select class="fselect" id="rm-type">
          <option>腦力激盪</option>
          <option>洽談室</option>
          <option>簡報廳</option>
          <option>視訊會議</option>
          <option>行政套房</option>
          <option>培訓教室</option>
        </select>
      </div>
      <div class="fg">
        <label>容納人數</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="finput" type="number" id="rm-capacity-min" placeholder="最少（選填）" min="1" style="flex:1;">
          <span style="color:var(--ink-60);white-space:nowrap;">～</span>
          <input class="finput" type="number" id="rm-capacity" placeholder="最多" min="1" style="flex:1;">
          <span style="color:var(--ink-60);white-space:nowrap;">人</span>
        </div>
        <div style="font-size:12px;color:var(--ink-60);margin-top:4px;">填寫最少人數可顯示「4～6 人」範圍</div>
      </div>
      <div class="fg">
        <label>每小時費率（NT$）</label>
        <input class="finput" type="number" id="rm-rate" placeholder="500" min="0">
      </div>
      <div class="fg">
        <label>樓層</label>
        <input class="finput" type="text" id="rm-floor" placeholder="例：3F">
      </div>
      <div class="fg">
        <label>狀態</label>
        <select class="fselect" id="rm-active">
          <option value="true">啟用</option>
          <option value="false">停用</option>
        </select>
      </div>
    </div>

    <div class="fg">
      <label>描述說明</label>
      <textarea class="ftarea" id="rm-desc" placeholder="詳細描述此會議室的特色、適用場景、注意事項..." rows="4" style="min-height:100px;"></textarea>
    </div>

    <div class="fg">
      <label>設備設施 <span>（輸入後按 Enter 新增）</span></label>
      <div class="amenity-input-row">
        <input class="finput" type="text" id="rm-amenity-input" placeholder="例：白板、投影機、WiFi" onkeydown="amenityKeydown(event)" style="flex:1;">
        <button class="btn btn-outline btn-sm" onclick="addAmenity()">新增</button>
      </div>
      <div class="amenity-tags" id="amenityTags"></div>
    </div>

    <div class="fg">
      <label>封面照片</label>
      <div class="current-photo-row" id="currentPhotoRow" style="display:none;">
        <img id="currentPhotoThumb" src="" alt="目前照片">
        <span>目前照片</span>
        <button class="btn btn-outline btn-sm" onclick="clearModalPhoto()">移除</button>
      </div>
      <div class="photo-upload-area" id="modalUploadArea" onclick="triggerModalFileInput()">
        <input type="file" id="modalPhotoInput" accept="image/*" onchange="handleModalPhotoSelect(event)" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
        <div class="photo-upload-icon">&#9728;</div>
        <div class="photo-upload-text">
          <strong>點擊選擇照片</strong> 或拖曳到此處<br>
          <small style="color:var(--ink-60);">支援 JPG、PNG、GIF、WEBP，最大 16MB</small>
        </div>
        <div class="upload-progress" id="modalUploadProgress">
          <div class="upload-progress-bar" id="modalUploadBar" style="width:0%"></div>
        </div>
      </div>
      <div id="modalPhotoPreview"></div>
      <input type="hidden" id="rm-photo-url">
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeRoomModal()">取消</button>
      <button class="btn btn-primary" onclick="saveRoom()">儲存</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const PW = sessionStorage.getItem('adminPw') || '';
if (!PW) window.location.href = '/admin';

const H = { 'X-Admin-Password': PW };
let amenities = [];
let allRooms = [];

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = (type === 'success' ? '' : '') + msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 3000);
}

function showPage(id, navEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
  const titles = {
    dashboard: '儀表板', bookings: '預約管理', rooms: '會議室管理',
    content: '文字內容編輯', photos: '照片管理', formfields: '表單欄位管理', blocked: '封鎖時段管理'
  };
  document.getElementById('topbarTitle').textContent = titles[id] || '';
  switch(id) {
    case 'dashboard': initFloorDate(); loadDashboard(); loadFloorStatus(); break;
    case 'bookings': loadBookings(); break;
    case 'rooms': loadRoomsAdmin(); break;
    case 'content': loadContent(); break;
    case 'photos': loadPhotos(); break;
    case 'formfields': loadFormFields(); break;
    case 'blocked': loadBlockedSlots(); break;
  }
}

function logout() {
  sessionStorage.removeItem('adminPw');
  window.location.href = '/admin';
}

// ── DASHBOARD ──
// ── 樓層時段看板 ──────────────────────────────────
function initFloorDate() {
  const el = document.getElementById('floor-date');
  if (el && !el.value) el.value = new Date().toISOString().split('T')[0];
}

async function loadFloorStatus() {
  const dateEl = document.getElementById('floor-date');
  const date = dateEl ? dateEl.value : new Date().toISOString().split('T')[0];
  const board = document.getElementById('floor-board');
  if (!board) return;
  board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink-60);">載入中...</div>';
  try {
    const res = await fetch(`/admin/api/floor-status?date=${date}`, { headers: H });
    const data = await res.json();
    if (!data.rooms || !data.rooms.length) {
      board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink-60);">無會議室資料</div>';
      return;
    }

    // 時間軸（每小時顯示一個刻度，8:00~22:00）
    const hours = [];
    for (let h = 8; h <= 22; h++) hours.push(h === 22 ? '' : h + ':00');
    // 28格，每兩格一小時
    const ticks = [];
    for (let i = 0; i < 28; i++) {
      ticks.push(i % 2 === 0 ? `${8 + Math.floor(i/2)}:00` : '');
    }

    // 現在時間 → 計算哪個 slot 是 "now"
    const now = new Date();
    const nowDate = now.toISOString().split('T')[0];
    const isToday = date === nowDate;
    const nowSlot = isToday
      ? Math.floor((now.getHours() * 60 + now.getMinutes() - 480) / 30)
      : -1;

    // 按樓層分組
    const floors = {};
    data.rooms.forEach(r => {
      const f = r.floor || '未分層';
      if (!floors[f]) floors[f] = [];
      floors[f].push(r);
    });

    // 排序樓層
    const floorOrder = Object.keys(floors).sort((a, b) => {
      const na = parseInt(a) || 0, nb = parseInt(b) || 0;
      return na - nb;
    });

    // 時間軸
    const axisHtml = `
      <div class="time-axis">
        ${ticks.map(t => `<div class="time-tick">${t}</div>`).join('')}
      </div>`;

    let html = axisHtml;

    floorOrder.forEach(floor => {
      html += `<div class="floor-section">
        <div class="floor-label">${floor}</div>`;

      floors[floor].forEach(r => {
        // 找每個 slot 的預約資訊（用來做 tooltip）
        const slotBookings = new Array(28).fill(null);
        r.bookings.forEach(b => {
          const sh = parseInt(b.start.split(':')[0]);
          const sm = parseInt(b.start.split(':')[1]);
          const eh = parseInt(b.end.split(':')[0]);
          const em = parseInt(b.end.split(':')[1]);
          const si = (sh * 60 + sm - 480) / 30;
          const ei = (eh * 60 + em - 480) / 30;
          for (let i = Math.max(0,si); i < Math.min(28,ei); i++) {
            slotBookings[i] = b;
          }
        });

        const cells = r.slots.map((booked, i) => {
          let cls = 'free';
          if (i < nowSlot) cls = 'past';
          else if (i === nowSlot) cls = booked ? 'now-booked' : 'now-free';
          else if (booked) cls = 'booked';

          const startH = 8 + Math.floor(i / 2);
          const startM = (i % 2) * 30;
          const endH = startH + (startM === 30 ? 1 : 0);
          const endM = startM === 30 ? 0 : 30;
          const timeLabel = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')}–${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;

          let tip = timeLabel;
          if (booked && slotBookings[i]) {
            tip = `${timeLabel}｜${slotBookings[i].name}（${slotBookings[i].number}）`;
          }

          return `<div class="slot-cell ${cls}" title="${tip}"></div>`;
        }).join('');

        html += `
          <div class="room-row">
            <div class="room-row-info">
              <div class="room-row-name" title="${r.name}">${r.name}</div>
              <div class="room-row-cap">${r.room_type}  ·  ${r.capacity_label || r.capacity + ' 人'}</div>
            </div>
            <div class="slots-wrap">${cells}</div>
          </div>`;
      });

      html += `</div>`; // floor-section
    });

    board.innerHTML = html;
  } catch(e) {
    board.innerHTML = '<div style="text-align:center;padding:20px;color:var(--red);">載入失敗，請重試</div>';
    console.error(e);
  }
}

async function loadDashboard() {
  try {
    const statsRes = await fetch('/admin/api/stats', { headers: H });
    const stats = await statsRes.json();
    document.getElementById('st-total').textContent = stats.total_bookings;
    document.getElementById('st-today').textContent = stats.today_bookings;
    document.getElementById('st-rooms').textContent = stats.total_rooms;
    document.getElementById('st-revenue').textContent = 'NT$' + (stats.total_revenue || 0).toLocaleString();
    document.getElementById('st-cancelled').textContent = stats.cancelled;
    document.getElementById('st-completed').textContent = stats.completed;

    // 填充會議室篩選選項
    const rr = await fetch('/admin/api/rooms', { headers: H });
    const rooms = await rr.json();
    const sel = document.getElementById('dash-fil-room');
    if (sel && sel.options.length <= 1) {
      rooms.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.name;
        sel.appendChild(opt);
      });
    }
  } catch(e) { console.error(e); }
  // 載入 logo
  try {
    const sc = await (await fetch('/api/site-content', { headers: H })).json();
    if (sc.logo_url) applyLogo(sc.logo_url);
  } catch(e) {}
  loadDashboardBookings();
}

async function loadDashboardBookings() {
  try {
    const date   = document.getElementById('dash-fil-date')?.value || '';
    const status = document.getElementById('dash-fil-status')?.value || '';
    const room   = document.getElementById('dash-fil-room')?.value || '';
    let url = '/admin/api/bookings?';
    if (date)   url += `date=${date}&`;
    if (status) url += `status=${status}&`;
    if (room)   url += `room_id=${room}&`;

    const res = await fetch(url, { headers: H });
    const bookings = await res.json();
    const tbody = document.getElementById('dash-bookings');
    if (!bookings.length) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--ink-60);">找不到符合的預約</td></tr>';
      return;
    }
    tbody.innerHTML = bookings.slice(0, 20).map(b => `
      <tr>
        <td><strong>${b.booking_number}</strong></td>
        <td>${b.customer_name}</td>
        <td>${b.room_name}</td>
        <td>${b.date}</td>
        <td>${fmtSegments(b)}</td>
        <td>${badgeHtml(b.status)}</td>
      </tr>`).join('');
  } catch(e) { console.error(e); }
}

function clearDashFilters() {
  const d = document.getElementById('dash-fil-date');
  const s = document.getElementById('dash-fil-status');
  const r = document.getElementById('dash-fil-room');
  if (d) d.value = '';
  if (s) s.value = '';
  if (r) r.value = '';
  loadDashboardBookings();
}

// ── BOOKINGS ──
async function loadBookings() {
  try {
    // populate room filter
    if (allRooms.length) {
      const sel = document.getElementById('fil-room');
      if (sel.options.length < 2) {
        allRooms.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.id;
          opt.textContent = r.name;
          sel.appendChild(opt);
        });
      }
    } else {
      const rr = await fetch('/admin/api/rooms', { headers: H });
      allRooms = await rr.json();
      const sel = document.getElementById('fil-room');
      allRooms.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.name;
        sel.appendChild(opt);
      });
    }

    const date = document.getElementById('fil-date').value;
    const status = document.getElementById('fil-status').value;
    const room = document.getElementById('fil-room').value;
    let url = '/admin/api/bookings?';
    if (date) url += `date=${date}&`;
    if (status) url += `status=${status}&`;
    if (room) url += `room_id=${room}`;

    const res = await fetch(url, { headers: H });
    const bookings = await res.json();
    const tbody = document.getElementById('bookings-tbody');
    if (!bookings.length) {
      tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:30px;color:var(--ink-60);">找不到符合的預約</td></tr>';
      return;
    }
    tbody.innerHTML = bookings.map(b => `
      <tr>
        <td><strong>${b.booking_number}</strong></td>
        <td>${b.customer_name}<br><small style="color:var(--ink-60);">${b.customer_phone}</small></td>
        <td>${b.department || '—'}</td>
        <td>${b.room_name}</td>
        <td>${b.date}</td>
        <td>${fmtSegments(b)}</td>
        <td>${b.duration}h</td>
        <td>${b.attendees}人</td>
        <td>NT$ ${(b.total_price||0).toLocaleString()}</td>
        <td>${badgeHtml(b.status)}</td>
        <td>
          ${b.status === 'confirmed' ? `
            <button class="btn btn-outline btn-sm" onclick="completeBooking(${b.id})" title="完成">完成</button>
            <button class="btn btn-danger btn-sm" onclick="cancelBooking(${b.id})" title="取消">取消</button>
          ` : '—'}
        </td>
      </tr>`).join('');
  } catch(e) { console.error(e); }
}

async function cancelBooking(id) {
  if (!confirm('確定要取消此預約？')) return;
  const res = await fetch(`/admin/api/bookings/${id}/cancel`, { method: 'POST', headers: H });
  if (res.ok) { toast('預約已取消'); loadBookings(); }
  else toast('操作失敗', 'error');
}

async function completeBooking(id) {
  if (!confirm('確定將此預約標記為完成？')) return;
  const res = await fetch(`/admin/api/bookings/${id}/complete`, { method: 'POST', headers: H });
  if (res.ok) { toast('已標記為完成'); loadBookings(); }
  else toast('操作失敗', 'error');
}

// ── ROOMS ADMIN ──
async function loadRoomsAdmin() {
  try {
    const res = await fetch('/admin/api/rooms', { headers: H });
    allRooms = await res.json();
    const ICONS = {'腦力激盪':'BS','洽談室':'MT','簡報廳':'PR','視訊會議':'VC','行政套房':'EX','培訓教室':'TR'};
    document.getElementById('roomAdminGrid').innerHTML = allRooms.map(r => {
      const icon = ICONS[r.room_type] || 'MR';
      const photoHTML = r.photo_url
        ? `<div class="rac-photo" style="position:relative;"><img src="${r.photo_url}" alt="${r.name}" onerror="this.parentElement.innerHTML='<div class=rac-photo-placeholder>${icon}</div>'"><span class="rac-status ${r.is_active ? 'badge-green' : 'badge-red'}">${r.is_active ? '啟用中' : '已停用'}</span></div>`
        : `<div class="rac-photo-placeholder" style="position:relative;">${icon}<span class="rac-status badge-gray" style="position:absolute;top:8px;right:8px;">${r.is_active ? '啟用中' : '已停用'}</span></div>`;
      return `
        <div class="room-admin-card ${r.is_active ? '' : 'inactive'}">
          ${photoHTML}
          <div class="rac-body">
            <div class="rac-type">${r.room_type}</div>
            <div class="rac-name">${r.name}</div>
            <div class="rac-meta">容納 ${r.capacity_label || r.capacity + ' 人'} · ${r.floor || 'F—'} · NT$ ${r.hourly_rate.toLocaleString()}/hr</div>
            ${r.description ? `<div class="rac-desc">${r.description.length > 60 ? r.description.slice(0,60) + '…' : r.description}</div>` : ''}
            <div class="rac-actions">
              <button class="btn btn-outline btn-sm" onclick="editRoom(${r.id})" style="flex:1;">編輯</button>
              <button class="btn btn-outline btn-sm" onclick="toggleRoomStatus(${r.id}, ${!r.is_active})" style="flex:1;">${r.is_active ? '停用' : '啟用'}</button>
            </div>
          </div>
        </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

async function toggleRoomStatus(id, newActive) {
  const res = await fetch(`/admin/api/rooms/${id}`, {
    method: 'PUT',
    headers: { ...H, 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_active: newActive })
  });
  if (res.ok) { toast(newActive ? '已啟用' : '已停用'); loadRoomsAdmin(); }
  else toast('操作失敗', 'error');
}

// ── ROOM MODAL ──
function openRoomModal(roomData = null) {
  document.getElementById('rm-id').value = '';
  document.getElementById('rm-name').value = '';
  document.getElementById('rm-type').value = '洽談室';
  document.getElementById('rm-capacity').value = '';
  document.getElementById('rm-capacity-min').value = '';
  document.getElementById('rm-rate').value = '';
  document.getElementById('rm-floor').value = '';
  document.getElementById('rm-desc').value = '';
  document.getElementById('rm-active').value = 'true';
  document.getElementById('rm-photo-url').value = '';
  document.getElementById('currentPhotoRow').style.display = 'none';
  document.getElementById('modalPhotoPreview').innerHTML = '';
  amenities = [];
  renderAmenities();
  document.getElementById('roomModalTitle').textContent = '新增會議室';
  document.getElementById('roomModal').classList.add('show');
}

function editRoom(id) {
  const r = allRooms.find(x => x.id === id);
  if (!r) return;
  document.getElementById('rm-id').value = r.id;
  document.getElementById('rm-name').value = r.name;
  document.getElementById('rm-type').value = r.room_type;
  document.getElementById('rm-capacity').value = r.capacity;
  document.getElementById('rm-capacity-min').value = r.capacity_min || '';
  document.getElementById('rm-rate').value = r.hourly_rate;
  document.getElementById('rm-floor').value = r.floor || '';
  document.getElementById('rm-desc').value = r.description || '';
  document.getElementById('rm-active').value = r.is_active ? 'true' : 'false';
  document.getElementById('rm-photo-url').value = r.photo_url || '';
  amenities = [...(r.amenities || [])];
  renderAmenities();

  const photoRow = document.getElementById('currentPhotoRow');
  if (r.photo_url) {
    photoRow.style.display = 'flex';
    document.getElementById('currentPhotoThumb').src = r.photo_url;
  } else {
    photoRow.style.display = 'none';
  }

  document.getElementById('roomModalTitle').textContent = `編輯：${r.name}`;
  document.getElementById('roomModal').classList.add('show');
}

function closeRoomModal() {
  document.getElementById('roomModal').classList.remove('show');
}

// Amenities
function amenityKeydown(e) { if (e.key === 'Enter') { e.preventDefault(); addAmenity(); } }
function addAmenity() {
  const input = document.getElementById('rm-amenity-input');
  const val = input.value.trim();
  if (val && !amenities.includes(val)) { amenities.push(val); renderAmenities(); }
  input.value = '';
  input.focus();
}
function removeAmenity(idx) { amenities.splice(idx, 1); renderAmenities(); }
function renderAmenities() {
  document.getElementById('amenityTags').innerHTML = amenities.map((a, i) =>
    `<span class="amenity-tag">${a} <span class="amenity-remove" onclick="removeAmenity(${i})">×</span></span>`
  ).join('');
}

// Photo upload in modal
function triggerModalFileInput() {
  // handled by input overlay
}

let pendingPhotoUrl = '';

async function handleModalPhotoSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const progress = document.getElementById('modalUploadProgress');
  const bar = document.getElementById('modalUploadBar');
  progress.style.display = 'block';
  bar.style.width = '30%';

  const formData = new FormData();
  formData.append('photo', file);
  try {
    bar.style.width = '70%';
    const res = await fetch('/admin/api/upload-photo', {
      method: 'POST',
      headers: { 'X-Admin-Password': PW },
      body: formData
    });
    bar.style.width = '100%';
    const data = await res.json();
    if (res.ok && data.photo_url) {
      document.getElementById('rm-photo-url').value = data.photo_url;
      pendingPhotoUrl = data.photo_url;
      document.getElementById('modalPhotoPreview').innerHTML = `
        <div class="photo-preview">
          <img src="${data.photo_url}" alt="預覽">
        </div>`;
      // Update current photo row
      document.getElementById('currentPhotoRow').style.display = 'flex';
      document.getElementById('currentPhotoThumb').src = data.photo_url;
      toast('照片上傳成功');
    } else {
      toast(data.error || '上傳失敗', 'error');
    }
  } catch {
    toast('上傳失敗', 'error');
  } finally {
    setTimeout(() => { progress.style.display = 'none'; bar.style.width = '0%'; }, 800);
  }
}

function clearModalPhoto() {
  document.getElementById('rm-photo-url').value = '';
  document.getElementById('currentPhotoRow').style.display = 'none';
  document.getElementById('modalPhotoPreview').innerHTML = '';
  toast('已移除照片');
}

async function saveRoom() {
  const id = document.getElementById('rm-id').value;
  const payload = {
    name: document.getElementById('rm-name').value.trim(),
    room_type: document.getElementById('rm-type').value,
    capacity: parseInt(document.getElementById('rm-capacity').value) || 10,
    capacity_min: parseInt(document.getElementById('rm-capacity-min').value) || 0,
    hourly_rate: parseInt(document.getElementById('rm-rate').value) || 500,
    floor: document.getElementById('rm-floor').value.trim(),
    description: document.getElementById('rm-desc').value.trim(),
    amenities: amenities,
    is_active: document.getElementById('rm-active').value === 'true',
    photo_url: document.getElementById('rm-photo-url').value,
  };
  if (!payload.name) { alert('請填寫會議室名稱'); return; }
  try {
    const url = id ? `/admin/api/rooms/${id}` : '/admin/api/rooms';
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, {
      method,
      headers: { ...H, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      toast(id ? '會議室已更新' : '會議室已新增');
      closeRoomModal();
      loadRoomsAdmin();
    } else {
      const err = await res.json();
      toast(err.error || '儲存失敗', 'error');
    }
  } catch { toast('儲存失敗', 'error'); }
}

// ── CONTENT ──
async function loadContent() {
  try {
    const res = await fetch('/admin/api/site-content', { headers: H });
    const data = await res.json();
    const keys = ['site_title','hero_badge','site_subtitle','site_description',
                  'step1_title','step2_title','step3_title',
                  'service_hours','contact_phone','contact_email','footer_text',
                  'notice_1','notice_2','notice_3','notice_4','notice_5'];
    keys.forEach(k => {
      const el = document.getElementById(`c-${k}`);
      if (el && data[k] !== undefined) el.value = data[k];
    });
  } catch { toast('載入失敗', 'error'); }
}

async function saveContent() {
  const keys = ['site_title','hero_badge','site_subtitle','site_description',
                'step1_title','step2_title','step3_title',
                'service_hours','contact_phone','contact_email','footer_text',
                'notice_1','notice_2','notice_3','notice_4','notice_5'];
  const payload = {};
  keys.forEach(k => {
    const el = document.getElementById(`c-${k}`);
    if (el) payload[k] = el.value.trim();
  });
  try {
    const res = await fetch('/admin/api/site-content', {
      method: 'POST',
      headers: { ...H, 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) toast('已儲存，前台將即時更新');
    else toast('儲存失敗', 'error');
  } catch { toast('儲存失敗', 'error'); }
}

// ── PHOTOS ──
async function loadPhotos() {
  try {
    const res = await fetch('/admin/api/rooms', { headers: H });
    allRooms = await res.json();
    const ICONS = {'腦力激盪':'BS','洽談室':'MT','簡報廳':'PR','視訊會議':'VC','行政套房':'EX','培訓教室':'TR'};

    document.getElementById('photoRoomList').innerHTML = allRooms.map(r => {
      const icon = ICONS[r.room_type] || 'MR';
      const photos = r.photos || (r.photo_url ? [r.photo_url] : []);
      const coverIdx = r.cover_index || 0;
      const canUpload = photos.length < 5;

      const photoGrid = photos.length > 0
        ? `<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;" id="photo-grid-${r.id}">
            ${photos.map((url, i) => `
              <div style="position:relative;width:120px;flex-shrink:0;">
                <img src="${url}" style="width:120px;height:90px;object-fit:cover;border-radius:8px;border:2px solid ${i===coverIdx?'var(--gold)':'var(--border)'};display:block;">
                ${i===coverIdx ? '<div style="position:absolute;top:4px;left:4px;background:var(--gold);color:#1a1a1a;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;">主封面</div>' : ''}
                <div style="display:flex;gap:4px;margin-top:4px;">
                  ${i!==coverIdx ? `<button class="btn btn-outline btn-sm" style="flex:1;font-size:11px;padding:3px;" onclick="setCover(${r.id},${i})">設為封面</button>` : '<div style="flex:1;text-align:center;font-size:11px;color:var(--gold);">✓ 封面</div>'}
                  <button class="btn btn-sm" style="background:#c44b3a;color:#fff;border:none;font-size:11px;padding:3px 8px;border-radius:4px;cursor:pointer;" onclick="deletePhoto(${r.id},${i})">✕</button>
                </div>
              </div>`).join('')}
          </div>`
        : `<div style="color:var(--ink-60);font-size:13px;margin-bottom:12px;">尚未上傳照片</div>`;

      return `
      <div class="card" style="margin-bottom:20px;">
        <div class="card-head">
          <div style="display:flex;align-items:center;gap:12px;">
            <div>
              <div class="card-title">${r.name}</div>
              <div style="font-size:12px;color:var(--ink-60);">${r.room_type} · ${r.floor||'F—'} · ${photos.length}/5 張</div>
            </div>
          </div>
          <span class="badge ${r.is_active?'badge-green':'badge-gray'}">${r.is_active?'啟用中':'已停用'}</span>
        </div>
        <div class="card-body">
          ${photoGrid}
          ${canUpload ? `
          <div class="photo-upload-area" style="position:relative;" id="drop-${r.id}"
            ondragover="dragover(event,${r.id})" ondragleave="dragleave(event,${r.id})" ondrop="handleDrop(event,${r.id})">
            <input type="file" accept="image/*" onchange="uploadRoomPhoto(event,${r.id})" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
            <div class="photo-upload-icon">&#43;</div>
            <div class="photo-upload-text"><strong>新增照片</strong>（還可上傳 ${5-photos.length} 張）<br><small>JPG、PNG、GIF、WEBP，最大 16MB</small></div>
            <div class="upload-progress" id="prog-${r.id}"><div class="upload-progress-bar" id="progbar-${r.id}" style="width:0%"></div></div>
          </div>` : `<div style="color:var(--ink-60);font-size:13px;text-align:center;padding:12px;">已達上限（5 張），請先刪除舊照片再上傳</div>`}
        </div>
      </div>`;
    }).join('');
  } catch(e) { console.error(e); }
}

function dragover(e, id) { e.preventDefault(); document.getElementById(`drop-${id}`).classList.add('dragover'); }
function dragleave(e, id) { document.getElementById(`drop-${id}`).classList.remove('dragover'); }
function handleDrop(e, id) {
  e.preventDefault();
  document.getElementById(`drop-${id}`).classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) uploadRoomPhotoFile(file, id);
}

async function uploadRoomPhoto(event, roomId) {
  const file = event.target.files[0];
  if (!file) return;
  const prog = document.getElementById(`prog-${roomId}`);
  const bar  = document.getElementById(`progbar-${roomId}`);
  if (prog) { prog.style.display = 'block'; bar.style.width = '30%'; }
  const fd = new FormData();
  fd.append('photo', file);
  try {
    if (bar) bar.style.width = '70%';
    const res  = await fetch(`/admin/api/rooms/${roomId}/photos`, {
      method: 'POST', headers: { 'X-Admin-Password': PW }, body: fd
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || '上傳失敗');
    if (bar) bar.style.width = '100%';
    toast('照片已上傳');
    setTimeout(() => loadPhotos(), 400);
  } catch(e) {
    toast(e.message || '上傳失敗', 'error');
  } finally {
    setTimeout(() => { if(prog){prog.style.display='none';bar.style.width='0%';} }, 1000);
  }
}

async function deletePhoto(roomId, idx) {
  if (!confirm('確定要刪除這張照片？')) return;
  const res = await fetch(`/admin/api/rooms/${roomId}/photos/${idx}`, {
    method: 'DELETE', headers: H
  });
  const data = await res.json();
  if (res.ok) { toast('已刪除'); loadPhotos(); }
  else toast(data.error || '刪除失敗', 'error');
}

async function setCover(roomId, idx) {
  const res = await fetch(`/admin/api/rooms/${roomId}/photos/cover`, {
    method: 'PUT',
    headers: { ...H, 'Content-Type': 'application/json' },
    body: JSON.stringify({ index: idx })
  });
  if (res.ok) { toast('主封面已設定'); loadPhotos(); }
  else toast('設定失敗', 'error');
}

async function removeRoomPhoto(roomId) {
  if (!confirm('確定要移除此照片？')) return;
  const res = await fetch(`/admin/api/rooms/${roomId}`, {
    method: 'PUT',
    headers: { ...H, 'Content-Type': 'application/json' },
    body: JSON.stringify({ photo_url: '' })
  });
  if (res.ok) { toast('照片已移除'); loadPhotos(); }
  else toast('操作失敗', 'error');
}

async function uploadLogo(event) {
  const file = event.target.files[0];
  if (!file) return;
  const status = document.getElementById('logoUploadStatus');
  status.style.display = 'block'; status.textContent = '上傳中...';
  const fd = new FormData();
  fd.append('photo', file);
  try {
    const res  = await fetch('/admin/api/site-logo', {
      method: 'POST', headers: { 'X-Admin-Password': PW }, body: fd
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || '上傳失敗');
    status.textContent = '✓ 已更新';
    // 即時更新 sidebar logo
    applyLogo(data.logo_url);
    toast('Logo 已更新');
  } catch(e) {
    status.textContent = '上傳失敗：' + e.message;
    toast(e.message, 'error');
  }
}

function applyLogo(url) {
  const wrap = document.getElementById('logoPreviewWrap');
  const icon = document.getElementById('sidebarLogoIcon');
  if (url) {
    if (wrap) wrap.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:contain;border-radius:8px;">`;
    if (icon) icon.innerHTML = `<img src="${url}" style="width:44px;height:44px;object-fit:contain;border-radius:6px;">`;
  }
}


// ══════════════════════════════════════════
// 表單欄位管理
// ══════════════════════════════════════════
const FF_DEFAULT = [
  {id:"name",      label:"聯絡人姓名", type:"text",     placeholder:"請輸入姓名",         required:true,  system:true,  full:false},
  {id:"phone",     label:"手機號碼",   type:"tel",      placeholder:"0912345678",          required:true,  system:true,  full:false},
  {id:"email",     label:"Email",     type:"email",    placeholder:"your@email.com",      required:true,  system:true,  full:false, hint:"必填，接收確認信"},
  {id:"department",label:"部門／公司", type:"text",     placeholder:"例：行銷部",           required:false, system:true,  full:false},
  {id:"attendees", label:"預計出席人數",type:"select",  options:"1,2,3,4,5,6,8,10,15,20,30,50", required:false, system:true, full:false},
  {id:"purpose",   label:"會議類型",   type:"select",   options:"部門會議,客戶洽談,員工培訓,產品發表,視訊會議,腦力激盪,其他", required:false, system:true, full:false},
  {id:"note",      label:"備註",      type:"textarea", placeholder:"特殊需求或注意事項...", required:false, system:true,  full:true}
];
let _ffFields = [];
let _ffDragIdx = null;

async function loadFormFields() {
  try {
    const sc = await (await fetch('/admin/api/site-content', {headers:H})).json();
    let fields;
    try { fields = sc.form_fields ? JSON.parse(sc.form_fields) : [...FF_DEFAULT]; }
    catch(e) { fields = [...FF_DEFAULT]; }
    _ffFields = fields;
    renderFFList();
  } catch(e) { console.error(e); }
}

function renderFFList() {
  const list = document.getElementById('ffList');
  list.innerHTML = _ffFields.map((f, i) => `
    <div class="card" style="padding:0;border:1px solid var(--border);border-radius:8px;background:var(--surface);"
      draggable="true" ondragstart="_ffDragStart(${i})" ondragover="_ffDragOver(event,${i})" ondrop="_ffDrop(event,${i})">
      <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;">
        <span style="cursor:grab;color:var(--ink-40);font-size:18px;padding:0 4px;">⠿</span>
        <div style="flex:1;display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;align-items:center;flex-wrap:wrap;">
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">欄位名稱</div>
            <input class="finput" style="padding:6px 8px;font-size:13px;" value="${esc(f.label)}"
              onchange="_ffUpdate(${i},'label',this.value)" placeholder="欄位名稱">
          </div>
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">類型</div>
            <select class="fselect" style="padding:6px 8px;font-size:13px;" onchange="_ffUpdate(${i},'type',this.value)" ${f.system?'disabled':''}>
              <option value="text" ${f.type==='text'?'selected':''}>文字</option>
              <option value="tel" ${f.type==='tel'?'selected':''}>電話</option>
              <option value="email" ${f.type==='email'?'selected':''}>Email</option>
              <option value="number" ${f.type==='number'?'selected':''}>數字</option>
              <option value="select" ${f.type==='select'?'selected':''}>下拉選單</option>
              <option value="textarea" ${f.type==='textarea'?'selected':''}>多行文字</option>
            </select>
          </div>
          <div>
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:3px;">${f.type==='select'?'選項（逗號分隔）':'提示文字'}</div>
            <input class="finput" style="padding:6px 8px;font-size:13px;"
              value="${esc(f.type==='select'?(f.options||''):(f.placeholder||''))}"
              onchange="_ffUpdate(${i},f.type==='select'?'options':'placeholder',this.value)"
              placeholder="${f.type==='select'?'選項1,選項2':'提示文字'}">
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:6px;">必填</div>
            <label style="display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;">
              <input type="checkbox" ${f.required?'checked':''} onchange="_ffUpdate(${i},'required',this.checked)" ${f.id==='name'||f.id==='phone'||f.id==='email'?'disabled':''}>
            </label>
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--ink-60);margin-bottom:6px;">全寬</div>
            <label style="display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer;">
              <input type="checkbox" ${f.full?'checked':''} onchange="_ffUpdate(${i},'full',this.checked)">
            </label>
          </div>
        </div>
        ${f.system ? '<span style="font-size:11px;color:var(--ink-40);padding:0 8px;">系統</span>'
          : `<button class="btn btn-sm" style="background:#c44b3a;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:4px 10px;flex-shrink:0;" onclick="_ffDelete(${i})">刪除</button>`}
      </div>
    </div>
  `).join('');
}

function esc(s) { return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function _ffUpdate(i, key, val) { _ffFields[i][key] = val; }
function _ffDelete(i) {
  if (!confirm(`確定刪除「${_ffFields[i].label}」欄位？`)) return;
  _ffFields.splice(i, 1);
  renderFFList();
}
function _ffDragStart(i) { _ffDragIdx = i; }
function _ffDragOver(e, i) { e.preventDefault(); }
function _ffDrop(e, i) {
  e.preventDefault();
  if (_ffDragIdx === null || _ffDragIdx === i) return;
  const moved = _ffFields.splice(_ffDragIdx, 1)[0];
  _ffFields.splice(i, 0, moved);
  _ffDragIdx = null;
  renderFFList();
}

function addFormField() {
  _ffFields.push({
    id: 'custom_' + Date.now(),
    label: '新欄位',
    type: 'text',
    placeholder: '',
    required: false,
    system: false,
    full: false
  });
  renderFFList();
  // scroll to bottom
  document.getElementById('ffList').lastElementChild?.scrollIntoView({behavior:'smooth'});
}

async function saveFormFields() {
  // 同步最新 input 值
  document.querySelectorAll('#ffList input[type=text], #ffList input[type=tel], #ffList input[type=email]').forEach(el => {
    const m = el.getAttribute('onchange')?.match(/_ffUpdate\((\d+),'(\w+)'/);
    if (m) _ffUpdate(parseInt(m[1]), m[2], el.value);
  });
  const res = await fetch('/admin/api/site-content', {
    method: 'POST',
    headers: {...H, 'Content-Type':'application/json'},
    body: JSON.stringify({form_fields: JSON.stringify(_ffFields)})
  });
  if (res.ok) toast('表單欄位已儲存');
  else toast('儲存失敗', 'error');
}

async function resetFormFields() {
  if (!confirm('確定還原為預設欄位？自訂欄位將全部清除。')) return;
  _ffFields = JSON.parse(JSON.stringify(FF_DEFAULT));
  renderFFList();
  await saveFormFields();
}


// ══════════════════════════════════════════
// 封鎖時段管理
// ══════════════════════════════════════════
const SLOT_TIMES = [];
for (let h = 8; h < 22; h++) {
  SLOT_TIMES.push(`${String(h).padStart(2,'0')}:00`);
  SLOT_TIMES.push(`${String(h).padStart(2,'0')}:30`);
}
SLOT_TIMES.push('22:00');

function initBlTimeSelects() {
  const startSel = document.getElementById('bl-start');
  if (!startSel || startSel.options.length > 0) return;
  SLOT_TIMES.slice(0, -1).forEach(t => {
    startSel.add(new Option(t, t));
  });
  updateBlEndOptions();
}

function updateBlEndOptions() {
  const startSel = document.getElementById('bl-start');
  const endSel   = document.getElementById('bl-end');
  if (!startSel || !endSel) return;
  const startIdx = SLOT_TIMES.indexOf(startSel.value);
  endSel.innerHTML = '';
  SLOT_TIMES.slice(startIdx + 1).forEach(t => {
    endSel.add(new Option(t, t));
  });
}

async function initBlRoomSelect() {
  const sel = document.getElementById('bl-room');
  if (!sel || sel.options.length > 1) return;
  const rooms = await (await fetch('/admin/api/rooms', {headers:H})).json();
  rooms.forEach(r => sel.add(new Option(`${r.floor||''} ${r.name}`, r.id)));
}

async function loadBlockedSlots() {
  initBlTimeSelects();
  initBlRoomSelect();
  const today = new Date().toISOString().slice(0,10);
  const fromEl = document.getElementById('bl-filter-from');
  const toEl   = document.getElementById('bl-filter-to');
  if (!fromEl.value) fromEl.value = today;
  let url = `/admin/api/blocked-slots?from=${fromEl.value}`;
  if (toEl.value) url += `&to=${toEl.value}`;
  const slots = await (await fetch(url, {headers:H})).json();
  const list = document.getElementById('blList');
  if (!slots.length) {
    list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--ink-60);">此期間沒有封鎖時段</div>';
    return;
  }
  // 依日期分組
  const byDate = {};
  slots.forEach(s => { if (!byDate[s.date]) byDate[s.date] = []; byDate[s.date].push(s); });
  list.innerHTML = Object.entries(byDate).map(([date, items]) => `
    <div style="margin-bottom:16px;">
      <div style="font-size:13px;font-weight:600;color:var(--ink-60);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border);">${date}</div>
      ${items.map(s => `
        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-light,#f0f0f0);">
          <div style="width:120px;font-weight:600;">${s.start_time} – ${s.end_time}</div>
          <div style="flex:1;color:var(--ink-60);font-size:13px;">${s.room_name}${s.reason ? ' · ' + s.reason : ''}</div>
          <button class="btn btn-sm" style="background:#c44b3a;color:#fff;border:none;border-radius:4px;cursor:pointer;padding:4px 12px;"
            onclick="deleteBlockedSlot(${s.id})">刪除</button>
        </div>`).join('')}
    </div>`).join('');
}

function clearBlFilter() {
  document.getElementById('bl-filter-from').value = '';
  document.getElementById('bl-filter-to').value = '';
  loadBlockedSlots();
}

async function addBlockedSlot() {
  const date  = document.getElementById('bl-date').value;
  const start = document.getElementById('bl-start').value;
  const end   = document.getElementById('bl-end').value;
  const room  = document.getElementById('bl-room').value;
  const reason= document.getElementById('bl-reason').value.trim();
  if (!date) { toast('請選擇日期', 'error'); return; }
  const status = document.getElementById('blAddStatus');
  status.style.display = 'block'; status.textContent = '新增中...';
  const res = await fetch('/admin/api/blocked-slots', {
    method: 'POST',
    headers: {...H, 'Content-Type':'application/json'},
    body: JSON.stringify({ date, start_time: start, end_time: end,
                           room_id: room ? parseInt(room) : null, reason })
  });
  if (res.ok) {
    status.textContent = '✓ 已新增';
    toast('封鎖時段已新增');
    loadBlockedSlots();
    setTimeout(() => { status.style.display='none'; }, 2000);
  } else {
    const d = await res.json();
    toast(d.error || '新增失敗', 'error');
    status.style.display = 'none';
  }
}

async function deleteBlockedSlot(id) {
  if (!confirm('確定刪除此封鎖時段？')) return;
  const res = await fetch(`/admin/api/blocked-slots/${id}`, { method:'DELETE', headers:H });
  if (res.ok) { toast('已刪除'); loadBlockedSlots(); }
  else toast('刪除失敗', 'error');
}

// ── HELPERS ──
function fmtSegments(b) {
  if (b.segments) {
    try {
      const segs = typeof b.segments === 'string' ? JSON.parse(b.segments) : b.segments;
      if (segs && segs.length > 1)
        return segs.map(s => `${s.start}–${s.end}`).join('<br>');
      if (segs && segs.length === 1)
        return `${segs[0].start} – ${segs[0].end}`;
    } catch(e) {}
  }
  return `${b.start_time} – ${b.end_time}`;
}

function badgeHtml(status) {
  const map = {
    confirmed: ['badge-green', '已確認'],
    cancelled: ['badge-red', '已取消'],
    completed: ['badge-gold', '已完成'],
  };
  const [cls, txt] = map[status] || ['badge-gray', status];
  return `<span class="badge ${cls}">${txt}</span>`;
}

// ── INIT ──
initFloorDate();
loadDashboard();
loadFloorStatus();
</script>
</body>
</html>